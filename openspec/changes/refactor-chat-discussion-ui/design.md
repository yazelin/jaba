# Design: refactor-chat-discussion-ui

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LINE Bot                                  â”‚
â”‚  (ç¾¤çµ„å°è©±) â”€â”€â–º jaba API â”€â”€â–º append_group_chat_history()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     jaba å¾Œç«¯ (main.py)                          â”‚
â”‚                                                                  â”‚
â”‚  1. ç¾¤çµ„å°è©±å­˜å…¥ data/linebot/sessions/{group_id}-chat.json     â”‚
â”‚  2. åŒæ™‚å­˜å…¥ data/daily_chat_messages.json (æ‰€æœ‰ç¾¤çµ„èšåˆ)        â”‚
â”‚  3. Socket.IO å»£æ’­äº‹ä»¶                                           â”‚
â”‚     - group_chat_updated: æŒ‡å®šç¾¤çµ„å°è©±æ›´æ–°                       â”‚
â”‚     - board_chat_message: æ‰€æœ‰ç¾¤çµ„å°è©±ï¼ˆçµ¦çœ‹æ¿ç”¨ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†å“¡ä»‹é¢ /manager â”‚                 â”‚   çœ‹æ¿é é¢ /         â”‚
â”‚                      â”‚                 â”‚                      â”‚
â”‚  - ç›£è½ group_chat_  â”‚                 â”‚  - ç›£è½ board_chat_  â”‚
â”‚    updated äº‹ä»¶      â”‚                 â”‚    message äº‹ä»¶      â”‚
â”‚  - åˆ‡æ›ç¾¤çµ„æ™‚è¼‰å…¥    â”‚                 â”‚  - é¡¯ç¤ºæ‰€æœ‰ç¾¤çµ„å°è©±  â”‚
â”‚    è©²ç¾¤çµ„å°è©±        â”‚                 â”‚  - éš”å¤©è‡ªå‹•æ¸…é™¤      â”‚
â”‚  - ç§»é™¤ç™¼é€åŠŸèƒ½      â”‚                 â”‚  - å”¯è®€æ¨¡å¼          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### 1. ç¾¤çµ„å°è©±ç™¼ç”Ÿæ™‚

```
LINE ç¾¤çµ„è¨Šæ¯
    â”‚
    â–¼
jaba-line-bot å‘¼å« /api/chat
    â”‚
    â–¼
ai.call_ai() è™•ç†ä¸¦å›æ‡‰
    â”‚
    â–¼
append_group_chat_history(group_id, ...)  â† ç¾æœ‰åŠŸèƒ½
    â”‚
    â–¼
append_to_board_chat(group_name, username, content)  â† æ–°å¢
    â”‚
    â”œâ”€â”€â–º Socket.IO: group_chat_updated { group_id, message }
    â”‚
    â””â”€â”€â–º Socket.IO: board_chat_message { group_name, username, content }
```

### 2. è³‡æ–™å„²å­˜çµæ§‹

**ç¾¤çµ„å°è©±** (ç¾æœ‰ï¼Œä¸è®Š):
```
data/linebot/sessions/{group_id}-chat.json
{
  "date": "2025-12-09",
  "messages": [
    { "username": "æ—äºæ¾¤", "role": "user", "content": "æˆ‘è¦é›è…¿ä¾¿ç•¶", "timestamp": "..." },
    { "username": "å‘·çˆ¸", "role": "assistant", "content": "å¥½å–”...", "timestamp": "..." }
  ]
}
```

**çœ‹æ¿ç”¨èšåˆå°è©±** (ä¿®æ”¹ç¾æœ‰ daily_chat_messages.json):
```
data/daily_chat_messages.json
{
  "date": "2025-12-09",
  "messages": [
    { "group_name": "åˆé¤ç¾¤", "username": "æ—äºæ¾¤", "content": "æˆ‘è¦é›è…¿ä¾¿ç•¶", "timestamp": "..." },
    { "group_name": "åˆé¤ç¾¤", "username": "å‘·çˆ¸", "content": "å¥½å–”...", "timestamp": "..." }
  ]
}
```

## API Changes

### New Endpoints

```
GET /api/groups/{group_id}/chat
  - å–å¾—æŒ‡å®šç¾¤çµ„çš„å°è©±è¨˜éŒ„
  - Response: { messages: [...], group_name: "..." }
```

### Modified Behavior

- `/api/chat` (ç¾¤çµ„æ¨¡å¼): å›æ‡‰å¾ŒåŒæ™‚å»£æ’­ Socket.IO äº‹ä»¶

### Socket.IO Events

| Event | Direction | Data | Purpose |
|-------|-----------|------|---------|
| `group_chat_updated` | Server â†’ Client | `{ group_id, message }` | é€šçŸ¥ç®¡ç†å“¡è©²ç¾¤çµ„æœ‰æ–°å°è©± |
| `board_chat_message` | Server â†’ Client | `{ group_name, username, content, timestamp }` | é€šçŸ¥çœ‹æ¿æœ‰æ–°å°è©± |

## UI Changes

### Manager Page (`/manager`)

**Before:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ ç¾é£Ÿè©•è«–å€          â–¼   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [èŠå¤©è¨Šæ¯...]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [è¼¸å…¥æ¡†] [ç™¼é€]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**After:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ {ç¾¤çµ„åç¨±} ç¾¤çµ„è¨è«–  â–¼  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚
â”‚ æ—äºæ¾¤: æˆ‘è¦é›è…¿ä¾¿ç•¶        â”‚
â”‚ å‘·çˆ¸: å¥½å–”ï¼Œæ—äºæ¾¤é»äº†...   â”‚
â”‚ ...                         â”‚
â”‚ (æ›´é«˜çš„é¡¯ç¤ºå€åŸŸ)            â”‚
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘ ç„¡è¼¸å…¥æ¡†ï¼Œå”¯è®€æ¨¡å¼
```

### Index Page (`/`)

**Before:** é¡¯ç¤ºåœ˜éšŠç¨ç«‹èŠå¤©è¨Šæ¯
**After:** é¡¯ç¤ºæ‰€æœ‰ç¾¤çµ„èˆ‡ jaba çš„å°è©±

## Implementation Notes

1. **ç¾¤çµ„åç¨±å–å¾—**: å¾ whitelist æˆ– session ä¸­å–å¾—ç¾¤çµ„åç¨±
2. **è¨Šæ¯æ ¼å¼çµ±ä¸€**: çµ±ä¸€ä½¿ç”¨ `{ username, content, timestamp, role?, group_name? }`
3. **æ•ˆèƒ½è€ƒé‡**: é™åˆ¶æœ€å¤šé¡¯ç¤º 50 ç­†è¨Šæ¯
4. **æ¸…é™¤æ©Ÿåˆ¶**: æ²¿ç”¨ç¾æœ‰çš„æ—¥æœŸæª¢æŸ¥æ©Ÿåˆ¶ï¼Œéš”å¤©è‡ªå‹•æ¸…é™¤
