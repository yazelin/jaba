<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>jiaba - ä»Šæ—¥è¨‚é¤çœ‹æ¿</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="board">
      <div class="board-header">
        <h1 class="board-title">ğŸ± jiaba è¨‚é¤çœ‹æ¿</h1>
        <p class="board-subtitle" id="today-date"></p>
      </div>

      <div class="store-name" id="store-name">
        <span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>
      </div>

      <div class="orders-section">
        <h2 class="section-title">ğŸ“‹ è¨‚å–®åˆ—è¡¨</h2>
        <div class="orders-list" id="orders-list">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ½ï¸</div>
            <p>é‚„æ²’æœ‰äººè¨‚é¤</p>
          </div>
        </div>
      </div>

      <div class="orders-section">
        <h2 class="section-title">ğŸ“Š å“é …çµ±è¨ˆ</h2>
        <div class="item-summary" id="item-summary">
          <div class="empty-state">
            <p>å°šç„¡çµ±è¨ˆè³‡æ–™</p>
          </div>
        </div>
      </div>

      <div class="grand-total" id="grand-total">
        <div class="grand-total-label">ç¸½é‡‘é¡</div>
        <div class="grand-total-amount">$0</div>
      </div>

      <div class="buttons">
        <a href="/order" class="btn btn-primary">ğŸ± æˆ‘è¦è¨‚ä¾¿ç•¶</a>
        <a href="/manager" class="btn btn-secondary">âš™ï¸ ç®¡ç†å“¡</a>
      </div>
    </div>
  </div>

  <script>
    // Socket.IO é€£ç·š
    const socket = io();

    // é¡¯ç¤ºä»Šæ—¥æ—¥æœŸ
    const today = new Date();
    document.getElementById('today-date').textContent =
      `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()} ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()]}`;

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
      try {
        const res = await fetch('/api/today');
        const data = await res.json();
        updateBoard(data);
      } catch (err) {
        console.error('è¼‰å…¥å¤±æ•—:', err);
      }
    }

    // æ›´æ–°çœ‹æ¿
    function updateBoard(data) {
      const { today: todayInfo, summary } = data;

      // æ›´æ–°åº—å®¶åç¨±
      const storeNameEl = document.getElementById('store-name');
      if (todayInfo && todayInfo.store_name) {
        storeNameEl.innerHTML = `ğŸª ${todayInfo.store_name}`;
      } else {
        storeNameEl.innerHTML = '<span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>';
      }

      // æ›´æ–°è¨‚å–®åˆ—è¡¨
      const ordersListEl = document.getElementById('orders-list');
      if (summary && summary.orders && summary.orders.length > 0) {
        ordersListEl.innerHTML = summary.orders.map(order => `
          <div class="order-card">
            <div>
              <div class="order-user">${order.username}</div>
              <div class="order-items">${order.items.map(i => `${i.name} x${i.quantity}`).join('ã€')}</div>
            </div>
            <div class="order-total">$${order.total}</div>
          </div>
        `).join('');
      } else {
        ordersListEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ½ï¸</div>
            <p>é‚„æ²’æœ‰äººè¨‚é¤</p>
          </div>
        `;
      }

      // æ›´æ–°å“é …çµ±è¨ˆ
      const itemSummaryEl = document.getElementById('item-summary');
      if (summary && summary.item_summary && summary.item_summary.length > 0) {
        itemSummaryEl.innerHTML = summary.item_summary.map(item =>
          `<span class="item-badge">${item.name} x${item.quantity}</span>`
        ).join('');
      } else {
        itemSummaryEl.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆè³‡æ–™</p></div>';
      }

      // æ›´æ–°ç¸½é‡‘é¡
      const grandTotal = summary ? summary.grand_total || 0 : 0;
      document.querySelector('.grand-total-amount').textContent = `$${grandTotal}`;
    }

    // é¡¯ç¤ºé€šçŸ¥
    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // ç›£è½å³æ™‚äº‹ä»¶
    socket.on('order_created', (data) => {
      showNotification(`${data.username} è¨‚äº†ä¾¿ç•¶ï¼`);
      loadData();
    });

    socket.on('order_updated', (data) => {
      showNotification(`${data.username} ä¿®æ”¹äº†è¨‚å–®`);
      loadData();
    });

    socket.on('order_cancelled', (data) => {
      showNotification(`${data.username} å–æ¶ˆäº†è¨‚å–®`);
      loadData();
    });

    socket.on('store_changed', (data) => {
      showNotification('ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼');
      loadData();
    });

    // åˆå§‹è¼‰å…¥
    loadData();

    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
    setInterval(loadData, 30000);
  </script>
</body>
</html>
