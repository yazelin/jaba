<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - ä»Šæ—¥è¨‚é¤çœ‹æ¿</title>
  <link rel="icon" type="image/png" href="/static/images/jaba.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container board-container">
    <div class="board board-wide">
      <!-- ä¸­ä¸Šï¼šæ¨™é¡Œ -->
      <div class="board-header">
        <h1 class="board-title"><img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="logo-icon"> å‘·çˆ¸è¨‚é¤çœ‹æ¿</h1>
        <p class="board-subtitle" id="today-date"></p>
      </div>

      <!-- å·¦å³å…©æ¬„ -->
      <div class="board-columns">
        <!-- å·¦æ¬„ï¼šåº—å®¶ + èŠå¤© + QRCode -->
        <div class="board-left">
          <div class="store-name" id="store-name">
            <span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>
          </div>

          <!-- ç¾é£Ÿè©•è«–å€ï¼ˆå”¯è®€ï¼‰ -->
          <div class="orders-section">
            <h2 class="section-title">ğŸ’¬ ç¾é£Ÿè©•è«–å€</h2>
            <div class="chat-readonly" id="chat-readonly">
              <div class="empty-state">
                <p>å°šç„¡èŠå¤©è¨Šæ¯</p>
              </div>
            </div>
          </div>

          <!-- LINE å¥½å‹ QRCode -->
          <div class="qrcode-section">
            <img src="/static/images/588voelu.png" alt="åŠ å…¥å‘·çˆ¸å¥½å‹" class="qrcode-image">
            <div class="qrcode-info">
              <p class="qrcode-title">åŠ å…¥å‘·çˆ¸å¥½å‹</p>
              <p class="qrcode-hint">æƒç¢¼åŠ å…¥ LINE ç¾¤çµ„é»é¤</p>
              <p class="linebot-status" id="linebot-status">
                <span class="linebot-status-icon">ğŸ”„</span>
                <span class="linebot-status-text">LINE Bot æª¢æŸ¥ä¸­...</span>
              </p>
            </div>
          </div>
        </div>

        <!-- å³æ¬„ï¼šè¨‚å–® + çµ±è¨ˆ + æŒ‰éˆ• -->
        <div class="board-right">
          <div class="orders-section">
            <h2 class="section-title">ğŸ“‹ è¨‚å–®åˆ—è¡¨</h2>
            <div class="orders-list" id="orders-list">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ½ï¸</div>
                <p>é‚„æ²’æœ‰äººè¨‚é¤</p>
              </div>
            </div>
          </div>

          <div class="orders-section">
            <h2 class="section-title">ğŸ“Š å“é …çµ±è¨ˆ</h2>
            <div class="item-summary" id="item-summary">
              <div class="empty-state">
                <p>å°šç„¡çµ±è¨ˆè³‡æ–™</p>
              </div>
            </div>
          </div>

          <div class="grand-total" id="grand-total">
            <div class="grand-total-label">ç¸½é‡‘é¡</div>
            <div class="grand-total-amount">$0</div>
          </div>

          <div class="buttons">
            <a href="/manager" class="btn btn-secondary">âš™ï¸ ç®¡ç†å“¡</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Socket.IO é€£ç·š
    const socket = io();

    // === ç€è¦½å™¨é€šçŸ¥ ===
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendBrowserNotification(title, body, tag = null) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: '/static/images/jaba.png',
          tag: tag || `jaba-${Date.now()}`,
          requireInteraction: false
        };

        const notification = new Notification(title, options);
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    requestNotificationPermission();

    // é¡¯ç¤ºä»Šæ—¥æ—¥æœŸ
    const today = new Date();
    document.getElementById('today-date').textContent =
      `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()} æ˜ŸæœŸ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()]}`;

    // è¼‰å…¥åº—å®¶è³‡æ–™
    async function loadStoreData() {
      try {
        const res = await fetch('/api/today');
        const data = await res.json();
        updateStoreDisplay(data);
      } catch (err) {
        console.error('è¼‰å…¥åº—å®¶å¤±æ•—:', err);
      }
    }

    // æ›´æ–°åº—å®¶é¡¯ç¤º
    function updateStoreDisplay(data) {
      const { stores: storesDetail } = data;
      const storeNameEl = document.getElementById('store-name');

      if (storesDetail && storesDetail.length > 0) {
        let storeHtml = '';
        storesDetail.forEach((storeData, index) => {
          const store = storeData.store;
          if (store) {
            if (index > 0) storeHtml += '<div class="store-divider-board"></div>';
            storeHtml += `<div class="store-name-item">ğŸª ${store.name}</div>`;
            if (store.phone) {
              storeHtml += `<div class="store-phone">ğŸ“ ${store.phone}</div>`;
            }
            if (store.note) {
              storeHtml += `<div class="store-note">ğŸ“Œ ${store.note}</div>`;
            }
          }
        });
        storeNameEl.innerHTML = storeHtml || '<span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>';
      } else {
        storeNameEl.innerHTML = '<span class="no-store">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</span>';
      }
    }

    // è¼‰å…¥ç¾¤çµ„è¨‚å–®
    async function loadGroupOrders() {
      try {
        const res = await fetch('/api/board/orders');
        const data = await res.json();
        updateGroupOrdersDisplay(data);
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„è¨‚å–®å¤±æ•—:', err);
      }
    }

    // æ›´æ–°ç¾¤çµ„è¨‚å–®é¡¯ç¤º
    function updateGroupOrdersDisplay(data) {
      const ordersListEl = document.getElementById('orders-list');
      const itemSummaryEl = document.getElementById('item-summary');

      // æ›´æ–°è¨‚å–®åˆ—è¡¨ï¼ˆåˆ†ç¾¤çµ„é¡¯ç¤ºï¼‰
      if (data.groups && data.groups.length > 0) {
        let html = '';
        data.groups.forEach((group, index) => {
          if (index > 0) html += '<div class="orders-group-divider"></div>';

          const statusIcon = group.status === 'ordering' ? 'ğŸŸ¢' : 'âšª';
          html += `<div class="orders-group-header">${statusIcon} ${group.group_name}</div>`;

          html += group.orders.map(order => `
            <div class="order-card">
              <div>
                <div class="order-user">${order.display_name || 'åŒ¿å'}</div>
                <div class="order-items">${order.items.map(i => `${i.name} x${i.quantity}${i.note ? ` (${i.note})` : ''}`).join('ã€')}</div>
              </div>
              <div class="order-total">$${order.total}</div>
            </div>
          `).join('');
        });
        ordersListEl.innerHTML = html;
      } else {
        ordersListEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ½ï¸</div>
            <p>é‚„æ²’æœ‰äººè¨‚é¤</p>
          </div>
        `;
      }

      // æ›´æ–°å“é …çµ±è¨ˆ
      if (data.item_summary && data.item_summary.length > 0) {
        itemSummaryEl.innerHTML = data.item_summary.map(item =>
          `<span class="item-badge">${item.name} x${item.quantity}</span>`
        ).join('');
      } else {
        itemSummaryEl.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆè³‡æ–™</p></div>';
      }

      // æ›´æ–°ç¸½é‡‘é¡
      document.querySelector('.grand-total-amount').textContent = `$${data.grand_total || 0}`;
    }

    // è¼‰å…¥æ‰€æœ‰è³‡æ–™
    function loadData() {
      loadStoreData();
      loadGroupOrders();
    }

    // é¡¯ç¤ºé€šçŸ¥
    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // ç›£è½å³æ™‚äº‹ä»¶ï¼ˆç¾¤çµ„è¨‚å–®ï¼‰
    socket.on('group_session_started', (data) => {
      showNotification(`${data.started_by || 'æœ‰äºº'} é–‹å§‹é»é¤ï¼`);
      sendBrowserNotification('é–‹å§‹é»é¤', `${data.started_by || 'æœ‰äºº'} é–‹å§‹é»é¤ï¼`, 'group-session-started');
      loadGroupOrders();
    });

    socket.on('group_order_updated', (data) => {
      showNotification(`${data.user || 'æœ‰äºº'} é»äº†é¤ï¼`);
      sendBrowserNotification('æ–°è¨‚å–®', `${data.user || 'æœ‰äºº'} é»äº†é¤ï¼`, 'group-order-updated');
      loadGroupOrders();
    });

    socket.on('group_session_ended', (data) => {
      showNotification(`é»é¤çµæŸï¼Œå…± ${data.order_count || 0} ç­†è¨‚å–®`);
      sendBrowserNotification('é»é¤çµæŸ', `å…± ${data.order_count || 0} ç­†è¨‚å–®`, 'group-session-ended');
      loadGroupOrders();
    });

    socket.on('store_changed', (data) => {
      const storeName = data.store_name || 'æ–°åº—å®¶';
      showNotification(`ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`);
      sendBrowserNotification('åº—å®¶æ›´æ–°', `ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`, 'store-changed');
      loadStoreData();
    });

    // === ç¾é£Ÿè©•è«–å€ï¼ˆé¡¯ç¤ºæ‰€æœ‰ç¾¤çµ„å°è©±ï¼‰===
    async function loadBoardChat() {
      try {
        const res = await fetch('/api/board/chat');
        const data = await res.json();
        updateBoardChatDisplay(data.messages || []);
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„å°è©±å¤±æ•—:', err);
      }
    }

    function updateBoardChatDisplay(messages) {
      const chatEl = document.getElementById('chat-readonly');

      if (!messages || messages.length === 0) {
        chatEl.innerHTML = '<div class="empty-state"><p>å°šç„¡èŠå¤©è¨Šæ¯</p></div>';
        return;
      }

      // åªé¡¯ç¤ºæœ€è¿‘ 15 å‰‡è¨Šæ¯
      const recentMessages = messages.slice(-15);

      chatEl.innerHTML = recentMessages.map(msg => {
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        const isJaba = msg.role === 'assistant' || msg.username === 'å‘·çˆ¸';
        const jabaClass = isJaba ? ' jaba' : '';
        // é¡¯ç¤ºæ ¼å¼ï¼š[ç¾¤çµ„åç¨±] ä½¿ç”¨è€…: å…§å®¹
        const groupPrefix = msg.group_name ? `<span class="chat-group-name">[${msg.group_name}]</span> ` : '';
        const content = (msg.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <div class="chat-readonly-message${jabaClass}">
            ${groupPrefix}<span class="chat-readonly-user">${msg.username}</span>
            <span class="chat-readonly-content">${content}</span>
            <span class="chat-readonly-time">${time}</span>
          </div>
        `;
      }).join('');

      // æ»¾å‹•åˆ°åº•éƒ¨
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addBoardChatMessage(msg) {
      const chatEl = document.getElementById('chat-readonly');

      // å¦‚æœæ˜¯ç©ºç‹€æ…‹ï¼Œæ¸…ç©º
      if (chatEl.querySelector('.empty-state')) {
        chatEl.innerHTML = '';
      }

      const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
        hour: '2-digit',
        minute: '2-digit'
      }) : new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      const isJaba = msg.role === 'assistant' || msg.username === 'å‘·çˆ¸';
      const jabaClass = isJaba ? ' jaba' : '';
      const groupPrefix = msg.group_name ? `<span class="chat-group-name">[${msg.group_name}]</span> ` : '';
      const content = (msg.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      const msgEl = document.createElement('div');
      msgEl.className = 'chat-readonly-message' + jabaClass;
      msgEl.innerHTML = `
        ${groupPrefix}<span class="chat-readonly-user">${msg.username}</span>
        <span class="chat-readonly-content">${content}</span>
        <span class="chat-readonly-time">${time}</span>
      `;
      chatEl.appendChild(msgEl);

      // åªä¿ç•™æœ€è¿‘ 15 å‰‡
      while (chatEl.children.length > 15) {
        chatEl.removeChild(chatEl.firstChild);
      }

      // æ»¾å‹•åˆ°åº•éƒ¨
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // ç›£è¯çœ‹æ¿èŠå¤©è¨Šæ¯ï¼ˆæ‰€æœ‰ç¾¤çµ„å°è©±ï¼‰
    socket.on('board_chat_message', (msg) => {
      addBoardChatMessage(msg);
    });

    // === LINE Bot ç‹€æ…‹æª¢æŸ¥ ===
    const LINEBOT_CHECK_INTERVAL = 60000; // 60 ç§’

    async function checkLineBotStatus() {
      const statusEl = document.getElementById('linebot-status');
      const iconEl = statusEl.querySelector('.linebot-status-icon');
      const textEl = statusEl.querySelector('.linebot-status-text');

      // é¡¯ç¤ºæª¢æŸ¥ä¸­ç‹€æ…‹
      statusEl.className = 'linebot-status checking';
      iconEl.textContent = 'ğŸ”„';
      textEl.textContent = 'LINE Bot æª¢æŸ¥ä¸­...';

      try {
        const res = await fetch('/api/linebot-status');
        const data = await res.json();

        if (data.status === 'online') {
          statusEl.className = 'linebot-status online';
          iconEl.textContent = 'ğŸŸ¢';
          textEl.textContent = data.message;
        } else {
          statusEl.className = 'linebot-status offline';
          iconEl.textContent = 'ğŸ”´';
          textEl.textContent = data.message;
        }
      } catch (err) {
        console.error('LINE Bot ç‹€æ…‹æª¢æŸ¥å¤±æ•—:', err);
        statusEl.className = 'linebot-status offline';
        iconEl.textContent = 'ğŸ”´';
        textEl.textContent = 'LINE Bot é›¢ç·š';
      }
    }

    // åˆå§‹è¼‰å…¥
    loadData();
    loadBoardChat();
    checkLineBotStatus();

    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°è³‡æ–™
    setInterval(loadData, 30000);

    // æ¯ 60 ç§’æª¢æŸ¥ LINE Bot ç‹€æ…‹
    setInterval(checkLineBotStatus, LINEBOT_CHECK_INTERVAL);
  </script>
</body>
</html>
