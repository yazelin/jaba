<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - ç®¡ç†å“¡</title>
  <link rel="icon" type="image/png" href="/static/images/jaba.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <a href="/" class="back-link">â† è¿”å›çœ‹æ¿</a>

  <!-- å¯†ç¢¼é©—è­‰ -->
  <div class="password-container" id="password-section">
    <div class="password-box">
      <h2>ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
      <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" autofocus onkeypress="handlePasswordKeyPress(event)">
      <br>
      <button class="btn btn-primary" onclick="verifyPassword()">ç™»å…¥</button>
      <p class="error-msg" id="error-msg" style="display: none;"></p>
    </div>
  </div>

  <!-- ç®¡ç†ä»‹é¢ -->
  <div class="container" id="manager-section" style="display: none;">
    <div class="order-page-layout">
      <!-- å·¦å´ï¼šå°è©±å€ -->
      <div class="chat-container">
        <div class="chat-header">
          <h1><img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="logo-icon"> å‘·çˆ¸ç®¡ç†æ¨¡å¼</h1>
        </div>

        <div class="chat-messages" id="chat-messages">
          <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
        </div>

        <div class="chat-input" id="chat-input">
          <input type="text" id="message-input" placeholder="è¼¸å…¥ç®¡ç†æŒ‡ä»¤..." onkeypress="handleKeyPress(event)">
          <button onclick="sendMessage()">ç™¼é€</button>
        </div>
      </div>

      <!-- å³å´ï¼šç®¡ç†é¢æ¿ -->
      <div class="side-panel" id="admin-panel">
        <!-- ä»Šæ—¥åº—å®¶è³‡è¨Š -->
        <div class="panel-card store-info-panel">
          <div class="panel-header">
            <span>ğŸª</span>
            <span>ä»Šæ—¥åº—å®¶</span>
          </div>
          <div class="panel-content" id="store-info-content">
            <div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>
          </div>
        </div>

        <!-- è¨‚å–®ç¸½è¦½é¢æ¿ -->
        <div class="panel-card orders-panel">
          <div class="panel-header">
            <span>ğŸ“¦</span>
            <span>ä»Šæ—¥è¨‚å–®</span>
          </div>
          <div class="panel-content" id="orders-content">
            <div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>
          </div>
        </div>

        <!-- ä»˜æ¬¾ç‹€æ…‹é¢æ¿ -->
        <div class="panel-card payments-panel">
          <div class="panel-header">
            <span>ğŸ’°</span>
            <span>ä»˜æ¬¾ç‹€æ…‹</span>
          </div>
          <div class="panel-content" id="payments-content">
            <div class="orders-empty">ç„¡ä»˜æ¬¾è³‡æ–™</div>
          </div>
        </div>

        <!-- åº—å®¶ç®¡ç†é¢æ¿ -->
        <div class="panel-card stores-panel">
          <div class="panel-header">
            <span>ğŸ¬</span>
            <span>åº—å®¶ç®¡ç†</span>
            <button class="panel-header-btn" onclick="openMenuUpload()" title="ä¸Šå‚³èœå–®åœ–ç‰‡">ğŸ“·</button>
          </div>
          <div class="panel-content stores-panel-content" id="stores-content">
            <div class="orders-empty">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- èœå–®åœ–ç‰‡ä¸Šå‚³å°è©±æ¡† -->
  <div class="modal-overlay" id="menu-upload-modal" style="display: none;">
    <div class="modal-content menu-upload-modal">
      <div class="modal-header">
        <h3>ğŸ“· ä¸Šå‚³èœå–®åœ–ç‰‡</h3>
        <button class="modal-close" onclick="closeMenuUpload()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- æ­¥é©Ÿ 1ï¼šä¸Šå‚³åœ–ç‰‡ -->
        <div id="upload-step" class="upload-step">
          <div class="upload-area" id="upload-area" onclick="document.getElementById('menu-image-input').click()">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</div>
            <div class="upload-hint">æ”¯æ´ JPGã€PNGï¼Œæœ€å¤§ 10MB</div>
          </div>
          <input type="file" id="menu-image-input" accept="image/jpeg,image/png" style="display: none;" onchange="handleImageSelect(event)">

          <div class="upload-preview" id="upload-preview" style="display: none;">
            <img id="preview-image" src="" alt="é è¦½">
            <button class="btn btn-secondary" onclick="clearImage()">æ¸…é™¤</button>
          </div>

          <div class="store-select">
            <label>é¸æ“‡åº—å®¶ï¼š</label>
            <select id="target-store-select">
              <option value="">-- é¸æ“‡ç¾æœ‰åº—å®¶ --</option>
              <option value="__new__">+ æ–°å¢åº—å®¶</option>
            </select>
            <input type="text" id="new-store-name" placeholder="è¼¸å…¥æ–°åº—å®¶åç¨±" style="display: none;">
          </div>

          <div class="upload-error" id="upload-error" style="display: none;"></div>

          <button class="btn btn-primary" id="recognize-btn" onclick="recognizeMenu()" disabled>
            ğŸ” é–‹å§‹è¾¨è­˜
          </button>
        </div>

        <!-- æ­¥é©Ÿ 2ï¼šè¾¨è­˜ä¸­ -->
        <div id="recognizing-step" class="upload-step" style="display: none;">
          <div class="loading-spinner"></div>
          <div class="loading-text">AI æ­£åœ¨è¾¨è­˜èœå–®ï¼Œè«‹ç¨å€™...</div>
        </div>

        <!-- æ­¥é©Ÿ 3ï¼šç·¨è¼¯çµæœ -->
        <div id="result-step" class="upload-step" style="display: none;">
          <div class="result-warnings" id="result-warnings"></div>
          <div class="result-editor" id="result-editor">
            <!-- å‹•æ…‹ç”Ÿæˆçš„ç·¨è¼¯è¡¨æ ¼ -->
          </div>
          <div class="result-actions">
            <button class="btn btn-secondary" onclick="backToUpload()">é‡æ–°ä¸Šå‚³</button>
            <button class="btn btn-primary" onclick="saveRecognizedMenu()">ç¢ºèªä¸¦å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åœ˜éšŠèŠå¤©å®¤ -->
  <div class="team-chat minimized" id="team-chat" style="display: none;">
    <div class="team-chat-header" onclick="toggleTeamChat()">
      <span class="team-chat-title">
        <span>ğŸ’¬ åœ˜éšŠèŠå¤©å®¤</span>
        <span class="unread-badge" id="unread-badge" style="display: none;">0</span>
      </span>
      <button class="team-chat-toggle" id="chat-toggle-btn">â–²</button>
    </div>
    <div class="team-chat-messages" id="team-chat-messages">
      <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
    </div>
    <div class="team-chat-input">
      <input type="text" id="team-chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleTeamChatKeyPress(event)">
      <button onclick="sendTeamChatMessage()">ç™¼é€</button>
    </div>
  </div>

  <script>
    const socket = io();
    const username = 'ç®¡ç†å“¡';
    let todayInfo = null;
    let todaySummary = null;
    let todayPayments = null;
    let todayStores = [];  // å¤šåº—å®¶è³‡æ–™
    let allStores = [];    // æ‰€æœ‰åº—å®¶è³‡æ–™ï¼ˆå«èœå–®ï¼‰

    // === ç€è¦½å™¨é€šçŸ¥ ===
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendBrowserNotification(title, body, tag = null) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: '/static/images/jaba.png',
          tag: tag || `jaba-${Date.now()}`,
          requireInteraction: false
        };

        const notification = new Notification(title, options);
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    requestNotificationPermission();

    // === ç®¡ç†é¢æ¿è³‡æ–™è¼‰å…¥ ===
    async function loadAdminData() {
      try {
        // åŒæ™‚è¼‰å…¥ä»Šæ—¥è³‡è¨Šå’Œä»˜æ¬¾è³‡æ–™
        const [todayRes, paymentsRes] = await Promise.all([
          fetch('/api/today'),
          fetch('/api/payments')
        ]);

        const todayData = await todayRes.json();
        const paymentsData = await paymentsRes.json();

        todayInfo = todayData.today;
        todaySummary = todayData.summary;
        todayPayments = paymentsData;
        todayStores = todayData.stores || [];

        // æ›´æ–°å„é¢æ¿ï¼ˆæ”¯æ´å¤šåº—å®¶ï¼‰
        updateStoreInfoPanel(todayData.today, todayData.stores);
        updateOrdersPanel(todayData.summary);
        updatePaymentsPanel(paymentsData);
      } catch (err) {
        console.error('è¼‰å…¥ç®¡ç†è³‡æ–™å¤±æ•—:', err);
      }
    }

    function updateStoreInfoPanel(today, stores) {
      const content = document.getElementById('store-info-content');

      // æ”¯æ´å¤šåº—å®¶
      if (stores && stores.length > 0) {
        let html = '';
        stores.forEach((storeData, index) => {
          const store = storeData.store;
          if (store) {
            if (index > 0) html += '<div class="store-divider"></div>';
            html += `<div class="store-title">${store.name}</div>`;
            if (store.note) {
              html += `<div class="store-note">${store.note}</div>`;
            }
          }
        });
        content.innerHTML = html || '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
        return;
      }

      // å‘å¾Œç›¸å®¹ï¼šå–®åº—å®¶
      if (!today || !today.store_name) {
        content.innerHTML = '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
        return;
      }
      content.innerHTML = `<div class="store-title">${today.store_name}</div>`;
    }

    function updateOrdersPanel(summary) {
      const content = document.getElementById('orders-content');
      if (!summary || !summary.orders || summary.orders.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>';
        return;
      }

      // å¤šåº—å®¶æ™‚æŒ‰åº—å®¶åˆ†çµ„
      const hasMultipleStores = todayStores && todayStores.length > 1;
      let html = '';

      if (hasMultipleStores) {
        // æŒ‰åº—å®¶åˆ†çµ„è¨‚å–®
        const ordersByStore = {};
        summary.orders.forEach(order => {
          const storeId = order.store_id || 'unknown';
          if (!ordersByStore[storeId]) {
            ordersByStore[storeId] = [];
          }
          ordersByStore[storeId].push(order);
        });

        // ä¾åº—å®¶é¡¯ç¤º
        Object.keys(ordersByStore).forEach((storeId, index) => {
          const orders = ordersByStore[storeId];
          const storeName = orders[0]?.store_name || 'æœªçŸ¥åº—å®¶';

          if (index > 0) html += '<div class="orders-store-divider"></div>';
          html += `<div class="orders-store-title">ğŸª ${storeName}</div>`;

          orders.forEach(order => {
            const itemsText = order.items.map(i => i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name).join('ã€');
            html += `
              <div class="live-order-item">
                <div>
                  <div class="live-order-user">${order.username}</div>
                  <div class="live-order-items">${itemsText}</div>
                </div>
                <div class="live-order-total">$${order.total}</div>
              </div>
            `;
          });
        });
      } else {
        // å–®åº—å®¶ï¼šç›´æ¥åˆ—å‡º
        summary.orders.forEach(order => {
          const itemsText = order.items.map(i => i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name).join('ã€');
          html += `
            <div class="live-order-item">
              <div>
                <div class="live-order-user">${order.username}</div>
                <div class="live-order-items">${itemsText}</div>
              </div>
              <div class="live-order-total">$${order.total}</div>
            </div>
          `;
        });
      }

      // åŠ ä¸Šç¸½è¨ˆ
      html += `
        <div class="orders-summary">
          <span class="orders-summary-label">ç¸½è¨ˆ ${summary.orders.length} ä»½</span>
          <span class="orders-summary-amount">$${summary.grand_total}</span>
        </div>
      `;
      content.innerHTML = html;
    }

    function updatePaymentsPanel(payments) {
      const content = document.getElementById('payments-content');
      if (!payments || !payments.records || payments.records.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç„¡ä»˜æ¬¾è³‡æ–™</div>';
        return;
      }

      let html = '';
      payments.records.forEach(record => {
        const paidClass = record.paid ? ' paid' : '';
        const statusText = record.paid ? 'å·²ä»˜' : 'æœªä»˜';
        const statusClass = record.paid ? 'paid' : 'pending';
        html += `
          <div class="payment-item${paidClass}">
            <div>
              <span class="payment-user">${record.username}</span>
              <span class="payment-amount">$${record.amount}</span>
            </div>
            <span class="payment-status ${statusClass}">${statusText}</span>
          </div>
        `;
      });

      // åŠ ä¸Šä»˜æ¬¾ç¸½è¦½
      html += `
        <div class="payments-summary">
          <div class="payments-summary-row">
            <span>å·²æ”¶æ¬¾</span>
            <span class="payments-collected">$${payments.total_collected || 0}</span>
          </div>
          <div class="payments-summary-row">
            <span>å¾…æ”¶æ¬¾</span>
            <span class="payments-pending">$${payments.total_pending || 0}</span>
          </div>
        </div>
      `;
      content.innerHTML = html;
    }

    // === åº—å®¶ç®¡ç†é¢æ¿ ===
    async function loadAllStores() {
      try {
        const res = await fetch('/api/stores/all');
        allStores = await res.json();
        updateStoresPanel(allStores);
      } catch (err) {
        console.error('è¼‰å…¥åº—å®¶è³‡æ–™å¤±æ•—:', err);
        document.getElementById('stores-content').innerHTML =
          '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function updateStoresPanel(stores) {
      const content = document.getElementById('stores-content');
      if (!stores || stores.length === 0) {
        content.innerHTML = '<div class="orders-empty">å°šç„¡åº—å®¶è³‡æ–™</div>';
        return;
      }

      let html = '';
      stores.forEach((storeData, index) => {
        const store = storeData.store;
        const menu = storeData.menu;
        const isActive = store.active !== false;
        const statusBadge = isActive
          ? '<span class="store-status active">å•Ÿç”¨</span>'
          : '<span class="store-status inactive">åœç”¨</span>';

        html += `
          <div class="store-manage-item">
            <div class="store-manage-header" onclick="toggleStoreMenu('store-menu-${index}')">
              <div class="store-manage-info">
                <span class="store-manage-name">${store.name}</span>
                ${statusBadge}
              </div>
              <span class="store-manage-toggle" id="toggle-${index}">â–¼</span>
            </div>
            <div class="store-manage-detail" id="store-menu-${index}" style="display: none;">
              <div class="store-manage-meta">
                <div>ID: ${store.id}</div>
                ${store.phone ? `<div>é›»è©±: ${store.phone}</div>` : ''}
                ${store.note ? `<div class="store-manage-note">ğŸ“Œ ${store.note}</div>` : ''}
              </div>
              <div class="store-manage-menu">
        `;

        if (menu && menu.categories && menu.categories.length > 0) {
          menu.categories.forEach(category => {
            html += `<div class="menu-cat-title">${category.name}</div>`;
            html += '<div class="menu-cat-items">';
            category.items.forEach(item => {
              const availClass = item.available === false ? ' unavailable' : '';
              html += `
                <div class="menu-cat-item${availClass}">
                  <span>${item.name}</span>
                  <span>$${item.price}</span>
                </div>
              `;
            });
            html += '</div>';
          });
        } else {
          html += '<div class="no-menu-msg">å°šç„¡èœå–®</div>';
        }

        html += `
              </div>
            </div>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    function toggleStoreMenu(menuId) {
      const menuEl = document.getElementById(menuId);
      const index = menuId.replace('store-menu-', '');
      const toggleEl = document.getElementById(`toggle-${index}`);

      if (menuEl.style.display === 'none') {
        menuEl.style.display = 'block';
        toggleEl.textContent = 'â–²';
      } else {
        menuEl.style.display = 'none';
        toggleEl.textContent = 'â–¼';
      }
    }

    // è™•ç†å¯†ç¢¼ Enter éµ
    function handlePasswordKeyPress(event) {
      if (event.key === 'Enter') {
        verifyPassword();
      }
    }

    // é©—è­‰å¯†ç¢¼
    async function verifyPassword() {
      const password = document.getElementById('password-input').value;
      const errorMsg = document.getElementById('error-msg');

      try {
        const res = await fetch('/api/verify-admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (data.success) {
          // éš±è—å¯†ç¢¼è¼¸å…¥ï¼Œé¡¯ç¤ºç®¡ç†ä»‹é¢
          document.getElementById('password-section').style.display = 'none';
          document.getElementById('manager-section').style.display = 'block';
          document.getElementById('team-chat').style.display = 'flex';

          // è¼‰å…¥ç®¡ç†è³‡æ–™
          loadAdminData();
          loadAllStores();

          // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
          addMessage('assistant', `æ­¡è¿ï¼Œç®¡ç†å“¡ï¼\n\nä½ å¯ä»¥ï¼š\nâ€¢ è¨­å®šä»Šæ—¥åº—å®¶ï¼ˆä¾‹ï¼šä»Šå¤©åƒ sample-storeï¼‰\nâ€¢ æ–°å¢ä»Šæ—¥åº—å®¶ï¼ˆä¾‹ï¼šä»Šå¤©å†åŠ ä¸€å®¶ another-storeï¼‰\nâ€¢ ç§»é™¤ä»Šæ—¥åº—å®¶ï¼ˆä¾‹ï¼šæŠŠ sample-store å¾ä»Šå¤©ç§»é™¤ï¼‰\nâ€¢ æ–°å¢åº—å®¶ï¼ˆä¾‹ï¼šæ–°å¢ä¸€å®¶åº—å«ã€Œç¾å‘³ä¾¿ç•¶ã€ï¼‰\nâ€¢ ç·¨è¼¯èœå–®ï¼ˆä¾‹ï¼šå¹« sample-store æ–°å¢ä¸€é“èœï¼‰\nâ€¢ æŸ¥çœ‹ä»Šæ—¥è¨‚å–®\nâ€¢ æŸ¥çœ‹ä»˜æ¬¾ç‹€æ…‹\nâ€¢ æ¨™è¨˜å·²ä»˜æ¬¾ï¼ˆä¾‹ï¼šå°æ˜å·²ä»˜æ¬¾ï¼‰\nâ€¢ æ¸…é™¤æ‰€æœ‰è¨‚å–®ï¼ˆä¾‹ï¼šæ¸…é™¤ä»Šæ—¥æ‰€æœ‰è¨‚å–®ï¼‰`);

          document.getElementById('message-input').focus();
          loadChatHistory();
        } else {
          errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤';
          errorMsg.style.display = 'block';
        }
      } catch (err) {
        errorMsg.textContent = 'é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorMsg.style.display = 'block';
        console.error(err);
      }
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', message);
      input.value = '';

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addMessage('assistant', 'è™•ç†ä¸­...');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            message: message,
            is_manager: true
          })
        });

        const data = await res.json();

        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(loadingId).remove();

        // é¡¯ç¤º AI å›æ‡‰
        addMessage('assistant', data.message || 'æ”¶åˆ°æŒ‡ä»¤ã€‚');

        // è™•ç†å‹•ä½œçµæœï¼ˆæ”¯æ´å¤šå€‹ actionsï¼‰
        const results = data.action_results || (data.action_result ? [data.action_result] : []);
        let needReloadStores = false;
        let needReloadAdmin = false;

        results.forEach(result => {
          if (result.success) {
            let resultMsg = 'âœ… æ“ä½œæˆåŠŸï¼';
            if (result.event === 'store_changed') {
              resultMsg = `âœ… å·²è¨­å®šä»Šæ—¥åº—å®¶ï¼š${result.today?.store_name || ''}`;
              needReloadAdmin = true;
            }
            // å¦‚æœæ˜¯åº—å®¶æˆ–èœå–®ç›¸é—œæ“ä½œï¼Œæ¨™è¨˜éœ€è¦é‡æ–°è¼‰å…¥
            if (result.store || result.menu) {
              needReloadStores = true;
            }
            addMessage('assistant', resultMsg);
          } else if (result.error) {
            addMessage('assistant', `âŒ æ“ä½œå¤±æ•—ï¼š${result.error}`);
          }
        });

        // æ‰¹æ¬¡é‡æ–°è¼‰å…¥
        if (needReloadAdmin) loadAdminData();
        if (needReloadStores) loadAllStores();

      } catch (err) {
        document.getElementById(loadingId).remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        console.error(err);
      }
    }

    // æ·»åŠ è¨Šæ¯åˆ°å°è©±å€åŸŸ
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const id = 'msg-' + Date.now();

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;

      if (role === 'assistant') {
        msgEl.innerHTML = `
          <div class="message-avatar">
            <img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="avatar-icon">
          </div>
          <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
        `;
      } else {
        msgEl.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;
      }

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // ç›£è¯äº‹ä»¶
    socket.on('order_created', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      }
      // é‡æ–°è¼‰å…¥ä»˜æ¬¾è³‡æ–™
      loadAdminData();
      showNotification(`${data.username} è¨‚äº†ä¾¿ç•¶ï¼`);
      sendBrowserNotification('æ–°è¨‚å–®', `${data.username} è¨‚äº†ä¾¿ç•¶ï¼`, 'order-created');
    });

    socket.on('order_cancelled', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      }
      // é‡æ–°è¼‰å…¥ä»˜æ¬¾è³‡æ–™
      loadAdminData();
      showNotification(`${data.username} å–æ¶ˆäº†è¨‚å–®`);
      sendBrowserNotification('è¨‚å–®å–æ¶ˆ', `${data.username} å–æ¶ˆäº†è¨‚å–®`, 'order-cancelled');
    });

    socket.on('orders_cleared', (data) => {
      // æ¸…ç©ºè¨‚å–®å’Œä»˜æ¬¾é¢æ¿
      updateOrdersPanel(null);
      updatePaymentsPanel(null);
      showNotification('æ‰€æœ‰è¨‚å–®å·²æ¸…é™¤');
    });

    socket.on('store_changed', (data) => {
      const storeName = data.store_name || 'æ–°åº—å®¶';
      // é‡æ–°è¼‰å…¥ç®¡ç†è³‡æ–™
      loadAdminData();
      showNotification(`ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`);
    });

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // === åœ˜éšŠèŠå¤©å®¤ ===
    let teamChatOpen = false;
    let unreadCount = 0;

    function toggleTeamChat() {
      const chatEl = document.getElementById('team-chat');
      teamChatOpen = !teamChatOpen;

      if (teamChatOpen) {
        chatEl.classList.remove('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–¼';
        unreadCount = 0;
        updateUnreadBadge();
        const messagesEl = document.getElementById('team-chat-messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        chatEl.classList.add('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–²';
      }
    }

    function updateUnreadBadge() {
      const badge = document.getElementById('unread-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function handleTeamChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendTeamChatMessage();
      }
    }

    async function sendTeamChatMessage() {
      const input = document.getElementById('team-chat-input');
      const content = input.value.trim();

      if (!content) return;

      input.value = '';

      try {
        await fetch('/api/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, content })
        });
      } catch (err) {
        console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', err);
      }
    }

    function addTeamChatMessage(msg) {
      const messagesEl = document.getElementById('team-chat-messages');
      const isOwn = msg.username === username;

      const msgEl = document.createElement('div');
      msgEl.className = `team-chat-message ${isOwn ? 'own' : ''}`;

      const time = new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
        hour: '2-digit',
        minute: '2-digit'
      });

      msgEl.innerHTML = `
        <div class="team-chat-message-header">
          <span class="team-chat-message-user">${msg.username}</span>
          <span class="team-chat-message-time">${time}</span>
        </div>
        <div class="team-chat-message-content">${msg.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
      `;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function loadChatHistory() {
      try {
        const res = await fetch('/api/chat/messages');
        const data = await res.json();

        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => addTeamChatMessage(msg));
        }
      } catch (err) {
        console.error('è¼‰å…¥èŠå¤©è¨˜éŒ„å¤±æ•—:', err);
      }
    }

    socket.on('chat_message', (msg) => {
      addTeamChatMessage(msg);

      if (msg.username !== username) {
        if (!teamChatOpen) {
          unreadCount++;
          updateUnreadBadge();
        }
        sendBrowserNotification(msg.username, msg.content, `chat-${msg.id}`);
      }
    });

    // === èœå–®åœ–ç‰‡è¾¨è­˜ ===
    let selectedImage = null;
    let recognizedMenu = null;
    let targetStoreId = null;

    function openMenuUpload() {
      document.getElementById('menu-upload-modal').style.display = 'flex';
      // å¡«å……åº—å®¶ä¸‹æ‹‰é¸å–®
      const select = document.getElementById('target-store-select');
      select.innerHTML = '<option value="">-- é¸æ“‡ç¾æœ‰åº—å®¶ --</option><option value="__new__">+ æ–°å¢åº—å®¶</option>';
      allStores.forEach(storeData => {
        const store = storeData.store;
        select.innerHTML += `<option value="${store.id}">${store.name}</option>`;
      });
      // é‡ç½®ç‹€æ…‹
      resetUploadState();
    }

    function closeMenuUpload() {
      document.getElementById('menu-upload-modal').style.display = 'none';
      resetUploadState();
    }

    function resetUploadState() {
      selectedImage = null;
      recognizedMenu = null;
      targetStoreId = null;
      document.getElementById('upload-step').style.display = 'block';
      document.getElementById('recognizing-step').style.display = 'none';
      document.getElementById('result-step').style.display = 'none';
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('upload-area').style.display = 'block';
      document.getElementById('recognize-btn').disabled = true;
      document.getElementById('menu-image-input').value = '';
      document.getElementById('target-store-select').value = '';
      document.getElementById('new-store-name').style.display = 'none';
      document.getElementById('new-store-name').value = '';
    }

    // è™•ç†åº—å®¶é¸æ“‡è®Šæ›´
    document.getElementById('target-store-select').addEventListener('change', (e) => {
      const newStoreInput = document.getElementById('new-store-name');
      if (e.target.value === '__new__') {
        newStoreInput.style.display = 'block';
      } else {
        newStoreInput.style.display = 'none';
      }
      updateRecognizeBtn();
    });

    // è™•ç†åœ–ç‰‡é¸æ“‡
    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        selectedImage = e.target.result;
        document.getElementById('preview-image').src = selectedImage;
        document.getElementById('upload-preview').style.display = 'block';
        document.getElementById('upload-area').style.display = 'none';
        updateRecognizeBtn();
      };
      reader.readAsDataURL(file);
    }

    function clearImage() {
      selectedImage = null;
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('upload-area').style.display = 'block';
      document.getElementById('menu-image-input').value = '';
      updateRecognizeBtn();
    }

    function updateRecognizeBtn() {
      const select = document.getElementById('target-store-select');
      const newStoreName = document.getElementById('new-store-name').value.trim();
      const hasStore = select.value && (select.value !== '__new__' || newStoreName);
      document.getElementById('recognize-btn').disabled = !selectedImage || !hasStore;
    }

    document.getElementById('new-store-name').addEventListener('input', updateRecognizeBtn);

    // æ‹–æ”¾æ”¯æ´
    const uploadArea = document.getElementById('upload-area');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        document.getElementById('menu-image-input').files = e.dataTransfer.files;
        handleImageSelect({ target: { files: e.dataTransfer.files } });
      }
    });

    // é–‹å§‹è¾¨è­˜
    function showUploadError(message) {
      const errorEl = document.getElementById('upload-error');
      errorEl.innerHTML = `<div class="error-box">âŒ ${message}</div>`;
      errorEl.style.display = 'block';
    }

    function hideUploadError() {
      const errorEl = document.getElementById('upload-error');
      errorEl.style.display = 'none';
    }

    async function recognizeMenu() {
      const select = document.getElementById('target-store-select');
      const storeId = select.value === '__new__' ? null : select.value;
      const storeName = select.value === '__new__' ? document.getElementById('new-store-name').value.trim() : null;

      hideUploadError();
      document.getElementById('upload-step').style.display = 'none';
      document.getElementById('recognizing-step').style.display = 'block';

      try {
        const res = await fetch('/api/recognize-menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: storeId,
            store_name: storeName,
            image: selectedImage
          })
        });

        const data = await res.json();

        if (data.error) {
          console.error('è¾¨è­˜éŒ¯èª¤:', data.error);
          showUploadError(data.error);
          document.getElementById('recognizing-step').style.display = 'none';
          document.getElementById('upload-step').style.display = 'block';
          return;
        }

        targetStoreId = data.store_id;
        recognizedMenu = data.recognized_menu;

        // é¡¯ç¤ºçµæœ
        showRecognitionResult(data.recognized_menu, data.warnings);

      } catch (err) {
        console.error('è¾¨è­˜å¤±æ•—:', err);
        showUploadError('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤ï¼š' + err.message);
        document.getElementById('recognizing-step').style.display = 'none';
        document.getElementById('upload-step').style.display = 'block';
      }
    }

    function showRecognitionResult(menu, warnings) {
      document.getElementById('recognizing-step').style.display = 'none';
      document.getElementById('result-step').style.display = 'block';

      // é¡¯ç¤ºè­¦å‘Š
      const warningsEl = document.getElementById('result-warnings');
      if (warnings && warnings.length > 0) {
        warningsEl.innerHTML = '<div class="warning-box">âš ï¸ ' + warnings.join('<br>') + '</div>';
      } else {
        warningsEl.innerHTML = '';
      }

      // ç”Ÿæˆç·¨è¼¯è¡¨æ ¼
      const editor = document.getElementById('result-editor');
      let html = '';

      if (menu && menu.categories) {
        menu.categories.forEach((category, catIdx) => {
          html += `
            <div class="result-category" data-cat-idx="${catIdx}">
              <div class="result-category-header">
                <input type="text" class="cat-name-input" value="${category.name}" data-cat-idx="${catIdx}">
                <button class="btn-icon" onclick="addItem(${catIdx})" title="æ–°å¢å“é …">â•</button>
                <button class="btn-icon btn-danger" onclick="removeCategory(${catIdx})" title="åˆªé™¤åˆ†é¡">ğŸ—‘ï¸</button>
              </div>
              <div class="result-items" id="cat-items-${catIdx}">
          `;

          if (category.items) {
            category.items.forEach((item, itemIdx) => {
              html += generateItemRow(catIdx, itemIdx, item);
            });
          }

          html += `
              </div>
            </div>
          `;
        });
      }

      html += '<button class="btn btn-secondary" onclick="addCategory()">+ æ–°å¢åˆ†é¡</button>';
      editor.innerHTML = html;
    }

    function generateItemRow(catIdx, itemIdx, item) {
      return `
        <div class="result-item" data-cat-idx="${catIdx}" data-item-idx="${itemIdx}">
          <input type="text" class="item-name" value="${item.name || ''}" placeholder="å“å">
          <input type="number" class="item-price" value="${item.price || 0}" placeholder="åƒ¹æ ¼">
          <input type="text" class="item-desc" value="${item.description || ''}" placeholder="èªªæ˜">
          <button class="btn-icon btn-danger" onclick="removeItem(${catIdx}, ${itemIdx})">ğŸ—‘ï¸</button>
        </div>
      `;
    }

    function addCategory() {
      recognizedMenu.categories.push({ name: 'æ–°åˆ†é¡', items: [] });
      showRecognitionResult(recognizedMenu, []);
    }

    function removeCategory(catIdx) {
      recognizedMenu.categories.splice(catIdx, 1);
      showRecognitionResult(recognizedMenu, []);
    }

    function addItem(catIdx) {
      recognizedMenu.categories[catIdx].items.push({
        id: `item-new-${Date.now()}`,
        name: '',
        price: 0,
        description: '',
        available: true
      });
      showRecognitionResult(recognizedMenu, []);
    }

    function removeItem(catIdx, itemIdx) {
      recognizedMenu.categories[catIdx].items.splice(itemIdx, 1);
      showRecognitionResult(recognizedMenu, []);
    }

    function backToUpload() {
      document.getElementById('result-step').style.display = 'none';
      document.getElementById('upload-step').style.display = 'block';
    }

    // å„²å­˜è¾¨è­˜çµæœ
    async function saveRecognizedMenu() {
      // å¾ DOM æ”¶é›†ç·¨è¼¯å¾Œçš„è³‡æ–™
      const categories = [];
      document.querySelectorAll('.result-category').forEach((catEl, catIdx) => {
        const catName = catEl.querySelector('.cat-name-input').value.trim() || 'æœªå‘½å';
        const items = [];

        catEl.querySelectorAll('.result-item').forEach((itemEl, itemIdx) => {
          const name = itemEl.querySelector('.item-name').value.trim();
          const price = parseInt(itemEl.querySelector('.item-price').value) || 0;
          const desc = itemEl.querySelector('.item-desc').value.trim();

          if (name) {
            items.push({
              id: `item-${catIdx}-${itemIdx}`,
              name: name,
              price: price,
              description: desc,
              available: true
            });
          }
        });

        if (items.length > 0 || catName) {
          categories.push({ name: catName, items: items });
        }
      });

      // å‘¼å« API å„²å­˜
      try {
        const res = await fetch('/api/save-menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: targetStoreId,
            categories: categories
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'å„²å­˜å¤±æ•—');
        }

        closeMenuUpload();
        loadAllStores();
        showNotification('èœå–®å·²å„²å­˜ï¼');

      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
      }
    }
  </script>
</body>
</html>
