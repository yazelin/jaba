<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>jiaba - ç®¡ç†å“¡</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <a href="/" class="back-link">â† è¿”å›çœ‹æ¿</a>

  <!-- å¯†ç¢¼é©—è­‰ -->
  <div class="password-container" id="password-section">
    <div class="password-box">
      <h2>ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
      <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" autofocus onkeypress="handlePasswordKeyPress(event)">
      <br>
      <button class="btn btn-primary" onclick="verifyPassword()">ç™»å…¥</button>
      <p class="error-msg" id="error-msg" style="display: none;"></p>
    </div>
  </div>

  <!-- ç®¡ç†ä»‹é¢ -->
  <div class="container" id="manager-section" style="display: none;">
    <div class="chat-container">
      <div class="chat-header">
        <h1>âš™ï¸ jiaba ç®¡ç†æ¨¡å¼</h1>
      </div>

      <div class="chat-messages" id="chat-messages">
        <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
      </div>

      <div class="chat-input" id="chat-input">
        <input type="text" id="message-input" placeholder="è¼¸å…¥ç®¡ç†æŒ‡ä»¤..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">ç™¼é€</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const username = 'ç®¡ç†å“¡';

    // è™•ç†å¯†ç¢¼ Enter éµ
    function handlePasswordKeyPress(event) {
      if (event.key === 'Enter') {
        verifyPassword();
      }
    }

    // é©—è­‰å¯†ç¢¼
    async function verifyPassword() {
      const password = document.getElementById('password-input').value;
      const errorMsg = document.getElementById('error-msg');

      try {
        const res = await fetch('/api/verify-admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (data.success) {
          // éš±è—å¯†ç¢¼è¼¸å…¥ï¼Œé¡¯ç¤ºç®¡ç†ä»‹é¢
          document.getElementById('password-section').style.display = 'none';
          document.getElementById('manager-section').style.display = 'block';

          // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
          addMessage('assistant', `æ­¡è¿ï¼Œç®¡ç†å“¡ï¼\n\nä½ å¯ä»¥ï¼š\nâ€¢ è¨­å®šä»Šæ—¥åº—å®¶ï¼ˆä¾‹ï¼šä»Šå¤©åƒ sample-storeï¼‰\nâ€¢ æ–°å¢åº—å®¶ï¼ˆä¾‹ï¼šæ–°å¢ä¸€å®¶åº—å«ã€Œç¾å‘³ä¾¿ç•¶ã€ï¼‰\nâ€¢ ç·¨è¼¯èœå–®ï¼ˆä¾‹ï¼šå¹« sample-store æ–°å¢ä¸€é“èœï¼‰\nâ€¢ æŸ¥çœ‹ä»Šæ—¥è¨‚å–®\nâ€¢ æŸ¥çœ‹ä»˜æ¬¾ç‹€æ…‹\nâ€¢ æ¨™è¨˜å·²ä»˜æ¬¾ï¼ˆä¾‹ï¼šå°æ˜å·²ä»˜æ¬¾ï¼‰`);

          document.getElementById('message-input').focus();
        } else {
          errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤';
          errorMsg.style.display = 'block';
        }
      } catch (err) {
        errorMsg.textContent = 'é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorMsg.style.display = 'block';
        console.error(err);
      }
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', message);
      input.value = '';

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addMessage('assistant', 'è™•ç†ä¸­...');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            message: message,
            is_manager: true
          })
        });

        const data = await res.json();

        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(loadingId).remove();

        // é¡¯ç¤º AI å›æ‡‰
        addMessage('assistant', data.message || 'æ”¶åˆ°æŒ‡ä»¤ã€‚');

        // å¦‚æœæœ‰åŸ·è¡Œå‹•ä½œï¼Œé¡¯ç¤ºçµæœ
        if (data.action_result) {
          if (data.action_result.success) {
            let resultMsg = 'âœ… æ“ä½œæˆåŠŸï¼';
            if (data.action_result.event === 'store_changed') {
              resultMsg = `âœ… å·²è¨­å®šä»Šæ—¥åº—å®¶ï¼š${data.action_result.today?.store_name}`;
            }
            addMessage('assistant', resultMsg);
          } else if (data.action_result.error) {
            addMessage('assistant', `âŒ æ“ä½œå¤±æ•—ï¼š${data.action_result.error}`);
          }
        }

      } catch (err) {
        document.getElementById(loadingId).remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        console.error(err);
      }
    }

    // æ·»åŠ è¨Šæ¯åˆ°å°è©±å€åŸŸ
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const id = 'msg-' + Date.now();

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;
      msgEl.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // ç›£è½äº‹ä»¶
    socket.on('order_created', (data) => {
      showNotification(`${data.username} è¨‚äº†ä¾¿ç•¶ï¼`);
    });

    socket.on('order_cancelled', (data) => {
      showNotification(`${data.username} å–æ¶ˆäº†è¨‚å–®`);
    });

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }
  </script>
</body>
</html>
