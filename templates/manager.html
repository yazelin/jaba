<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - ç®¡ç†å“¡</title>
  <link rel="icon" type="image/png" href="/static/images/jaba.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- å¯†ç¢¼é©—è­‰ -->
  <div class="password-container" id="password-section">
    <a href="/" class="back-link back-link-standalone">â† è¿”å›çœ‹æ¿</a>
    <div class="password-box">
      <h2>ğŸ” ç®¡ç†å“¡ç™»å…¥</h2>
      <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" autofocus onkeypress="handlePasswordKeyPress(event)">
      <br>
      <button class="btn btn-primary" onclick="verifyPassword()">ç™»å…¥</button>
      <p class="error-msg" id="error-msg" style="display: none;"></p>
    </div>
  </div>

  <!-- ç®¡ç†ä»‹é¢ -->
  <div class="container admin-container" id="manager-section" style="display: none;">
    <div class="admin-three-columns">
      <!-- å·¦å´ï¼šåº—å®¶ç®¡ç† -->
      <div class="admin-left-panel">
        <div class="panel-card stores-panel">
          <div class="panel-header">
            <span>ğŸ¬</span>
            <span>åº—å®¶ç®¡ç†</span>
          </div>
          <button class="menu-upload-btn" onclick="openMenuUpload()">
            ğŸ“· ä¸Šå‚³èœå–®
          </button>
          <div class="panel-content stores-panel-content" id="stores-content">
            <div class="orders-empty">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- ä¸­é–“ï¼šå°è©±å€ -->
      <div class="chat-container">
        <div class="chat-header">
          <a href="/" class="back-link">â† è¿”å›</a>
          <h1><img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="logo-icon"> å‘·çˆ¸ç®¡ç†æ¨¡å¼</h1>
          <div class="header-spacer"></div>
        </div>

        <div class="chat-messages" id="chat-messages">
          <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
        </div>

        <div class="chat-input" id="chat-input">
          <input type="text" id="message-input" placeholder="è¼¸å…¥ç®¡ç†æŒ‡ä»¤..." onkeypress="handleKeyPress(event)">
          <button onclick="sendMessage()">ç™¼é€</button>
        </div>
      </div>

      <!-- å³å´ï¼šè³‡è¨Šé¢æ¿ -->
      <div class="admin-right-panel">
        <!-- ä»Šæ—¥åº—å®¶è³‡è¨Š -->
        <div class="panel-card store-info-panel">
          <div class="panel-header">
            <span>ğŸª</span>
            <span>ä»Šæ—¥åº—å®¶</span>
          </div>
          <div class="panel-content" id="store-info-content">
            <div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>
          </div>
        </div>

        <!-- ç¾¤çµ„é¸æ“‡å™¨ -->
        <div class="panel-card group-selector-panel">
          <div class="panel-header">
            <span>ğŸ‘¥</span>
            <span>ç¾¤çµ„è¨‚å–®ç®¡ç†</span>
          </div>
          <div class="panel-content">
            <select id="group-selector" onchange="loadGroupOrders()">
              <option value="">-- é¸æ“‡ç¾¤çµ„ --</option>
            </select>
            <button class="btn btn-sm btn-secondary" onclick="refreshGroups()" title="é‡æ–°æ•´ç†">ğŸ”„</button>
          </div>
        </div>

        <!-- ç¾¤çµ„è¨‚å–®åˆ—è¡¨é¢æ¿ -->
        <div class="panel-card orders-panel">
          <div class="panel-header">
            <span>ğŸ“¦</span>
            <span>ç¾¤çµ„è¨‚å–®</span>
            <button class="btn btn-sm btn-primary" id="proxy-order-btn" onclick="openProxyOrder()" style="display: none;">+ ä»£ç†é»é¤</button>
          </div>
          <div class="panel-content" id="orders-content">
            <div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>
          </div>
        </div>

        <!-- ä»˜æ¬¾ç‹€æ…‹é¢æ¿ -->
        <div class="panel-card payments-panel">
          <div class="panel-header">
            <span>ğŸ’°</span>
            <span>ä»˜æ¬¾ç‹€æ…‹</span>
          </div>
          <div class="panel-content" id="payments-content">
            <div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>
          </div>
        </div>

        <!-- è¨‚å–®çµ±è¨ˆé¢æ¿ -->
        <div class="panel-card stats-panel">
          <div class="panel-header">
            <span>ğŸ“Š</span>
            <span>è¨‚å–®çµ±è¨ˆ</span>
          </div>
          <div class="panel-content" id="stats-content">
            <div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- èœå–®åœ–ç‰‡ä¸Šå‚³å°è©±æ¡† -->
  <div class="modal-overlay" id="menu-upload-modal" style="display: none;">
    <div class="modal-content menu-upload-modal">
      <div class="modal-header">
        <h3>ğŸ“· ä¸Šå‚³èœå–®åœ–ç‰‡</h3>
        <button class="modal-close" onclick="closeMenuUpload()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- æ­¥é©Ÿ 1ï¼šä¸Šå‚³åœ–ç‰‡ -->
        <div id="upload-step" class="upload-step">
          <div class="upload-area" id="upload-area" onclick="document.getElementById('menu-image-input').click()">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</div>
            <div class="upload-hint">æ”¯æ´ JPGã€PNGï¼Œæœ€å¤§ 10MB</div>
          </div>
          <input type="file" id="menu-image-input" accept="image/jpeg,image/png" style="display: none;" onchange="handleImageSelect(event)">

          <div class="upload-preview" id="upload-preview" style="display: none;">
            <img id="preview-image" src="" alt="é è¦½">
            <button class="btn btn-secondary" onclick="clearImage()">æ¸…é™¤</button>
          </div>

          <div class="store-select">
            <label>é¸æ“‡åº—å®¶ï¼š</label>
            <select id="target-store-select">
              <option value="">-- é¸æ“‡ç¾æœ‰åº—å®¶ --</option>
              <option value="__new__">+ æ–°å¢åº—å®¶</option>
            </select>
            <input type="text" id="new-store-name" placeholder="è¼¸å…¥æ–°åº—å®¶åç¨±" style="display: none;">
          </div>

          <div class="upload-error" id="upload-error" style="display: none;"></div>

          <button class="btn btn-primary" id="recognize-btn" onclick="recognizeMenu()" disabled>
            ğŸ” é–‹å§‹è¾¨è­˜
          </button>
        </div>

        <!-- æ­¥é©Ÿ 2ï¼šè¾¨è­˜ä¸­ -->
        <div id="recognizing-step" class="upload-step" style="display: none;">
          <div class="loading-jaba">
            <img src="/static/images/jaba-keyin.png" alt="å‘·çˆ¸" class="loading-jaba-icon">
            <div class="loading-spinner-ring"></div>
          </div>
          <div class="loading-text">å‘·çˆ¸æ­£åœ¨åŠªåŠ› key èœå–®...</div>
        </div>

        <!-- æ­¥é©Ÿ 3ï¼šç·¨è¼¯çµæœ -->
        <div id="result-step" class="upload-step" style="display: none;">
          <div class="result-warnings" id="result-warnings"></div>
          <div class="result-editor" id="result-editor">
            <!-- å‹•æ…‹ç”Ÿæˆçš„ç·¨è¼¯è¡¨æ ¼ -->
          </div>
          <div class="result-actions">
            <button class="btn btn-secondary" id="back-btn" onclick="backToUpload()">é‡æ–°ä¸Šå‚³</button>
            <button class="btn btn-primary" onclick="saveRecognizedMenu()">ç¢ºèªä¸¦å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä»£ç†é»é¤å°è©±æ¡† -->
  <div class="modal-overlay" id="proxy-order-modal" style="display: none;">
    <div class="modal-content proxy-order-modal">
      <div class="modal-header">
        <h3>ğŸ“ ä»£ç†é»é¤</h3>
        <button class="modal-close" onclick="closeProxyOrder()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="proxy-order-form">
          <div class="form-group">
            <label>ä½¿ç”¨è€…ï¼š</label>
            <select id="proxy-user-select">
              <option value="">-- é¸æ“‡ä½¿ç”¨è€… --</option>
              <option value="__new__">+ æ–°å¢ä½¿ç”¨è€…</option>
            </select>
            <input type="text" id="new-user-name" placeholder="è¼¸å…¥æ–°ä½¿ç”¨è€…åç¨±" style="display: none;">
          </div>
          <div class="form-group">
            <label>é¤é»ï¼š</label>
            <select id="proxy-item-select">
              <option value="">-- é¸æ“‡é¤é» --</option>
            </select>
          </div>
          <div class="form-group">
            <label>æ•¸é‡ï¼š</label>
            <input type="number" id="proxy-quantity" value="1" min="1" max="10">
          </div>
          <div class="form-group">
            <label>å‚™è¨»ï¼š</label>
            <input type="text" id="proxy-note" placeholder="ä¾‹ï¼šä¸è¦é…¸èœã€ç„¡ç³–å»å†°">
          </div>
        </div>
        <div class="proxy-order-actions">
          <button class="btn btn-secondary" onclick="closeProxyOrder()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="submitProxyOrder()">ç¢ºèªé»é¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯è¨‚å–®å°è©±æ¡† -->
  <div class="modal-overlay" id="edit-order-modal" style="display: none;">
    <div class="modal-content edit-order-modal">
      <div class="modal-header">
        <h3>âœï¸ ç·¨è¼¯è¨‚å–®</h3>
        <button class="modal-close" onclick="closeEditOrder()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="edit-order-user" id="edit-order-user"></div>
        <div class="edit-order-items" id="edit-order-items">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="edit-order-actions">
          <button class="btn btn-danger" onclick="deleteEntireOrder()">åˆªé™¤æ•´ç­†è¨‚å–®</button>
          <button class="btn btn-secondary" onclick="closeEditOrder()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveEditedOrder()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div class="modal-overlay" id="confirm-modal" style="display: none;">
    <div class="modal-content confirm-modal">
      <div class="confirm-modal-body">
        <div class="confirm-modal-icon" id="confirm-modal-icon">ğŸ’°</div>
        <div class="confirm-modal-message" id="confirm-modal-message"></div>
      </div>
      <div class="confirm-modal-actions">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="confirm-modal-ok">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ç¾¤çµ„è¨è«–å€ï¼ˆåŸç¾é£Ÿè©•è«–å€ï¼Œç¾æ”¹ç‚ºé¡¯ç¤ºé¸å®šç¾¤çµ„çš„ LINE å°è©±ï¼‰ -->
  <div class="team-chat team-chat-readonly" id="team-chat" style="display: none;">
    <div class="team-chat-header" onclick="toggleTeamChat()">
      <span class="team-chat-title">
        <span id="group-chat-title">ğŸ’¬ è«‹é¸æ“‡ç¾¤çµ„</span>
        <span class="unread-badge" id="unread-badge" style="display: none;">0</span>
      </span>
      <button class="team-chat-toggle" id="chat-toggle-btn">â–¼</button>
    </div>
    <div class="team-chat-messages team-chat-messages-tall" id="team-chat-messages">
      <!-- ç¾¤çµ„å°è©±æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
      <div class="chat-empty-hint">é¸æ“‡ç¾¤çµ„ä»¥æŸ¥çœ‹å°è©±è¨˜éŒ„</div>
    </div>
    <!-- ç§»é™¤è¼¸å…¥æ¡†ï¼Œæ”¹ç‚ºå”¯è®€æ¨¡å¼ -->
  </div>

  <script>
    const socket = io();
    const username = 'ç®¡ç†å“¡';
    let todayInfo = null;
    let todaySummary = null;
    let todayPayments = null;
    let todayStores = [];  // å¤šåº—å®¶è³‡æ–™
    let allStores = [];    // æ‰€æœ‰åº—å®¶è³‡æ–™ï¼ˆå«èœå–®ï¼‰

    // ç¾¤çµ„è¨‚å–®ç®¡ç†
    let allGroups = [];           // æ‰€æœ‰ç¾¤çµ„åˆ—è¡¨
    let selectedGroupId = null;   // ç•¶å‰é¸æ“‡çš„ç¾¤çµ„
    let currentGroupOrders = null; // ç•¶å‰ç¾¤çµ„çš„è¨‚å–®è³‡æ–™
    let editingUserId = null;     // æ­£åœ¨ç·¨è¼¯çš„ä½¿ç”¨è€… ID

    // === ç€è¦½å™¨é€šçŸ¥ ===
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendBrowserNotification(title, body, tag = null) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: '/static/images/jaba.png',
          tag: tag || `jaba-${Date.now()}`,
          requireInteraction: false
        };

        const notification = new Notification(title, options);
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    requestNotificationPermission();

    // === ç®¡ç†é¢æ¿è³‡æ–™è¼‰å…¥ ===
    async function loadAdminData(forUsername = null) {
      try {
        // åŒæ™‚è¼‰å…¥ä»Šæ—¥è³‡è¨Šå’Œä»˜æ¬¾è³‡æ–™
        const todayUrl = forUsername ? `/api/today?username=${encodeURIComponent(forUsername)}` : '/api/today';
        const [todayRes, paymentsRes] = await Promise.all([
          fetch(todayUrl),
          fetch('/api/payments')
        ]);

        const todayData = await todayRes.json();
        const paymentsData = await paymentsRes.json();

        todayInfo = todayData.today;
        todaySummary = todayData.summary;
        todayPayments = paymentsData;
        todayStores = todayData.stores || [];

        // æ›´æ–°å„é¢æ¿
        updateStoreInfoPanel(todayData.stores);
        updateOrdersPanel(todayData.summary);
        updatePaymentsPanel(paymentsData);

        return todayData.preferred_name;
      } catch (err) {
        console.error('è¼‰å…¥ç®¡ç†è³‡æ–™å¤±æ•—:', err);
        return null;
      }
    }

    function updateStoreInfoPanel(stores) {
      const content = document.getElementById('store-info-content');

      if (stores && stores.length > 0) {
        let html = '';
        stores.forEach((storeData, index) => {
          const store = storeData.store;
          if (store) {
            if (index > 0) html += '<div class="store-divider"></div>';
            html += `<div class="store-title">${store.name}</div>`;
            if (store.phone) {
              html += `<div class="store-phone">é›»è©±ï¼š${store.phone}</div>`;
            }
            if (store.note) {
              html += `<div class="store-note">${store.note}</div>`;
            }
          }
        });
        content.innerHTML = html || '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
      } else {
        content.innerHTML = '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
      }
    }

    function updateOrdersPanel(summary) {
      const content = document.getElementById('orders-content');
      if (!summary || !summary.orders || summary.orders.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>';
        return;
      }

      // å¤šåº—å®¶æ™‚æŒ‰åº—å®¶åˆ†çµ„
      const hasMultipleStores = todayStores && todayStores.length > 1;
      let html = '';

      if (hasMultipleStores) {
        // æŒ‰åº—å®¶åˆ†çµ„è¨‚å–®
        const ordersByStore = {};
        summary.orders.forEach(order => {
          const storeId = order.store_id || 'unknown';
          if (!ordersByStore[storeId]) {
            ordersByStore[storeId] = [];
          }
          ordersByStore[storeId].push(order);
        });

        // ä¾åº—å®¶é¡¯ç¤º
        Object.keys(ordersByStore).forEach((storeId, index) => {
          const orders = ordersByStore[storeId];
          const storeName = orders[0]?.store_name || 'æœªçŸ¥åº—å®¶';

          if (index > 0) html += '<div class="orders-store-divider"></div>';
          html += `<div class="orders-store-title">ğŸª ${storeName}</div>`;

          orders.forEach(order => {
            const itemsText = order.items.map(i => {
              let text = i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name;
              if (i.note) text += ` (${i.note})`;
              return text;
            }).join('ã€');
            html += `
              <div class="live-order-item">
                <div>
                  <div class="live-order-user">${order.username}</div>
                  <div class="live-order-items">${itemsText}</div>
                </div>
                <div class="live-order-total">$${order.total}</div>
              </div>
            `;
          });
        });
      } else {
        // å–®åº—å®¶ï¼šç›´æ¥åˆ—å‡º
        summary.orders.forEach(order => {
          const itemsText = order.items.map(i => {
            let text = i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name;
            if (i.note) text += ` (${i.note})`;
            return text;
          }).join('ã€');
          html += `
            <div class="live-order-item">
              <div>
                <div class="live-order-user">${order.username}</div>
                <div class="live-order-items">${itemsText}</div>
              </div>
              <div class="live-order-total">$${order.total}</div>
            </div>
          `;
        });
      }

      // åŠ ä¸Šç¸½è¨ˆ
      html += `
        <div class="orders-summary">
          <span class="orders-summary-label">ç¸½è¨ˆ ${summary.orders.length} ä»½</span>
          <span class="orders-summary-amount">$${summary.grand_total}</span>
        </div>
      `;
      content.innerHTML = html;
    }

    function updatePaymentsPanel(payments) {
      const content = document.getElementById('payments-content');
      if (!payments || !payments.records || payments.records.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç„¡ä»˜æ¬¾è³‡æ–™</div>';
        return;
      }

      let html = '';
      payments.records.forEach(record => {
        const paidAmount = record.paid_amount || 0;
        const amount = record.amount || 0;

        // åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹
        let statusText, statusClass, paidClass = '';
        let showRefundBtn = false;
        let showPaidBtn = false;

        if (!record.paid && paidAmount > 0) {
          // éƒ¨åˆ†å·²ä»˜ï¼ˆå¾…è£œï¼‰
          statusText = `å¾…è£œ $${amount - paidAmount}`;
          statusClass = 'partial';
          showPaidBtn = true;  // å¯ä»¥ç¢ºèªä»˜æ¬¾
        } else if (record.paid && record.note && record.note.startsWith('å¾…é€€')) {
          // å¾…é€€æ¬¾
          statusText = record.note;
          statusClass = 'refund';
          showRefundBtn = true;
        } else if (record.paid) {
          // å·²ä»˜
          statusText = 'å·²ä»˜';
          statusClass = 'paid';
          paidClass = ' paid';
        } else {
          // æœªä»˜
          statusText = 'æœªä»˜';
          statusClass = 'pending';
          showPaidBtn = true;  // å¯ä»¥ç¢ºèªä»˜æ¬¾
        }

        html += `
          <div class="payment-item${paidClass}">
            <div>
              <span class="payment-user">${record.username}</span>
              <span class="payment-amount">$${amount}</span>
              ${record.note && !showRefundBtn ? `<span class="payment-note" title="${record.note}">ğŸ“</span>` : ''}
            </div>
            <div class="payment-actions">
              ${showPaidBtn ? `<button class="btn-paid" onclick="confirmPaid('${record.username}')">ç¢ºèªä»˜æ¬¾</button>` : ''}
              ${showRefundBtn ? `<button class="btn-refund" onclick="confirmRefund('${record.username}')">ç¢ºèªé€€æ¬¾</button>` : ''}
              <span class="payment-status ${statusClass}">${statusText}</span>
            </div>
          </div>
        `;
      });

      // åŠ ä¸Šä»˜æ¬¾ç¸½è¦½
      html += `
        <div class="payments-summary">
          <div class="payments-summary-row">
            <span>å·²æ”¶æ¬¾</span>
            <span class="payments-collected">$${payments.total_collected || 0}</span>
          </div>
          <div class="payments-summary-row">
            <span>å¾…æ”¶æ¬¾</span>
            <span class="payments-pending">$${payments.total_pending || 0}</span>
          </div>
        </div>
      `;
      content.innerHTML = html;
    }

    // === åº—å®¶ç®¡ç†é¢æ¿ ===
    async function toggleStoreActive(storeId) {
      try {
        const res = await fetch(`/api/store/${storeId}/toggle`, {
          method: 'POST'
        });
        const data = await res.json();
        if (data.success) {
          const statusText = data.active ? 'å•Ÿç”¨' : 'åœç”¨';
          showNotification(`åº—å®¶å·²${statusText}`);
          loadAllStores();
        } else {
          showNotification(`åˆ‡æ›å¤±æ•—ï¼š${data.error}`);
        }
      } catch (err) {
        console.error('åˆ‡æ›åº—å®¶ç‹€æ…‹å¤±æ•—:', err);
        showNotification('åˆ‡æ›å¤±æ•—');
      }
    }

    async function loadAllStores() {
      try {
        const res = await fetch('/api/stores/all');
        allStores = await res.json();
        updateStoresPanel(allStores);
      } catch (err) {
        console.error('è¼‰å…¥åº—å®¶è³‡æ–™å¤±æ•—:', err);
        document.getElementById('stores-content').innerHTML =
          '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function updateStoresPanel(stores) {
      const content = document.getElementById('stores-content');
      if (!stores || stores.length === 0) {
        content.innerHTML = '<div class="orders-empty">å°šç„¡åº—å®¶è³‡æ–™</div>';
        return;
      }

      let html = '';
      stores.forEach((storeData, index) => {
        const store = storeData.store;
        const menu = storeData.menu;
        const isActive = store.active !== false;
        const statusBtn = isActive
          ? `<button class="store-status-btn active" onclick="event.stopPropagation(); toggleStoreActive('${store.id}')">å•Ÿç”¨</button>`
          : `<button class="store-status-btn inactive" onclick="event.stopPropagation(); toggleStoreActive('${store.id}')">åœç”¨</button>`;

        html += `
          <div class="store-manage-item">
            <div class="store-manage-header" onclick="toggleStoreMenu('store-menu-${index}')">
              <div class="store-manage-info">
                <span class="store-manage-name">${store.name}</span>
                <span class="store-edit-btn" onclick="event.stopPropagation(); editStoreMenu('${store.id}')">ç·¨è¼¯</span>
                ${statusBtn}
              </div>
              <span class="store-manage-toggle" id="toggle-${index}">â–¼</span>
            </div>
            <div class="store-manage-detail" id="store-menu-${index}" style="display: none;">
              <div class="store-manage-meta">
                <div>ID: ${store.id}</div>
                ${store.phone ? `<div>é›»è©±: ${store.phone}</div>` : ''}
                ${store.note ? `<div class="store-manage-note">ğŸ“Œ ${store.note}</div>` : ''}
              </div>
              <div class="store-manage-menu">
        `;

        if (menu && menu.categories && menu.categories.length > 0) {
          menu.categories.forEach(category => {
            html += `<div class="menu-cat-title">${category.name}</div>`;
            html += '<div class="menu-cat-items">';
            category.items.forEach(item => {
              const availClass = item.available === false ? ' unavailable' : '';
              let priceDisplay = '';
              if (item.variants && item.variants.length > 0) {
                priceDisplay = item.variants.map(v => `${v.name} $${v.price}`).join(' / ');
              } else {
                priceDisplay = `$${item.price}`;
              }
              html += `
                <div class="menu-cat-item${availClass}">
                  <span>${item.name}</span>
                  <span>${priceDisplay}</span>
                </div>
              `;
            });
            html += '</div>';
          });
        } else {
          html += '<div class="no-menu-msg">å°šç„¡èœå–®</div>';
        }

        html += `
              </div>
            </div>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    // === ç¾¤çµ„è¨‚å–®ç®¡ç† ===
    async function loadGroups() {
      try {
        const res = await fetch('/api/super-admin/groups');
        const data = await res.json();
        allGroups = data.groups || [];
        updateGroupSelector();
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„å¤±æ•—:', err);
      }
    }

    function refreshGroups() {
      loadGroups();
      if (selectedGroupId) {
        loadGroupOrders();
      }
      showNotification('å·²é‡æ–°æ•´ç†');
    }

    function updateGroupSelector() {
      const select = document.getElementById('group-selector');
      let html = '<option value="">-- é¸æ“‡ç¾¤çµ„ --</option>';

      allGroups.forEach(group => {
        const selected = group.id === selectedGroupId ? 'selected' : '';
        // å¦‚æœæ²’æœ‰ç¾¤çµ„åç¨±ï¼Œé¡¯ç¤º ID çš„å¾Œ 8 ç¢¼
        const displayName = group.name || `ç¾¤çµ„ ...${group.id.slice(-8)}`;
        html += `<option value="${group.id}" ${selected}>${displayName} (${group.member_count}äºº)</option>`;
      });

      if (allGroups.length === 0) {
        html = '<option value="">å°šç„¡å·²å•Ÿç”¨çš„ç¾¤çµ„</option>';
      }

      select.innerHTML = html;

      // ç¢ºä¿é¸ä¸­ç‹€æ…‹è¢«æ­£ç¢ºæ¢å¾©
      if (selectedGroupId) {
        select.value = selectedGroupId;
      }
    }

    // é‡æ–°è¼‰å…¥ç•¶å‰é¸ä¸­ç¾¤çµ„çš„è¨‚å–®ï¼ˆä¸æ”¹è®Šé¸ä¸­ç‹€æ…‹ï¼‰
    async function reloadCurrentGroupOrders() {
      if (!selectedGroupId) return;

      // è¼‰å…¥ç¾¤çµ„å°è©±
      loadGroupChat(selectedGroupId);

      try {
        const res = await fetch(`/api/super-admin/groups/${selectedGroupId}/orders`);
        const data = await res.json();
        currentGroupOrders = data;
        renderGroupOrders(data);
        renderPayments(data);
        renderStats(data);
        document.getElementById('proxy-order-btn').style.display = 'block';
      } catch (err) {
        console.error('é‡æ–°è¼‰å…¥ç¾¤çµ„è¨‚å–®å¤±æ•—:', err);
      }
    }

    async function loadGroupOrders() {
      const groupId = document.getElementById('group-selector').value;
      selectedGroupId = groupId;

      // åŒæ™‚è¼‰å…¥ç¾¤çµ„å°è©±
      loadGroupChat(groupId);

      if (!groupId) {
        document.getElementById('orders-content').innerHTML = '<div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>';
        document.getElementById('payments-content').innerHTML = '<div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>';
        document.getElementById('stats-content').innerHTML = '<div class="orders-empty">è«‹é¸æ“‡ç¾¤çµ„</div>';
        document.getElementById('proxy-order-btn').style.display = 'none';
        currentGroupOrders = null;
        return;
      }

      try {
        const res = await fetch(`/api/super-admin/groups/${groupId}/orders`);
        const data = await res.json();
        currentGroupOrders = data;

        updateGroupOrdersPanel(data);
        updateGroupPaymentsPanel(data);
        updateGroupStatsPanel(data);

        // é¡¯ç¤ºä»£ç†é»é¤æŒ‰éˆ•ï¼ˆåƒ…åœ¨é»é¤é€²è¡Œä¸­ï¼‰
        document.getElementById('proxy-order-btn').style.display =
          data.status === 'ordering' ? 'inline-block' : 'none';

      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„è¨‚å–®å¤±æ•—:', err);
        document.getElementById('orders-content').innerHTML = '<div class="orders-empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function updateGroupOrdersPanel(data) {
      const content = document.getElementById('orders-content');
      const orders = data.orders || [];

      if (orders.length === 0) {
        content.innerHTML = '<div class="orders-empty">è©²ç¾¤çµ„å°šç„¡è¨‚å–®</div>';
        return;
      }

      let html = '';
      orders.forEach(order => {
        const displayName = order.display_name || 'æœªçŸ¥';
        const itemsHtml = order.items.map(item => {
          let text = item.quantity > 1 ? `${item.name} x${item.quantity}` : item.name;
          if (item.note) text += ` (${item.note})`;
          return `<div class="order-item-line">${text} $${item.subtotal || item.price * item.quantity}</div>`;
        }).join('');

        html += `
          <div class="group-order-item">
            <div class="group-order-header">
              <span class="group-order-user">ğŸ‘¤ ${displayName}</span>
              <span class="group-order-total">$${order.total}</span>
              <button class="btn-icon btn-edit" onclick="openEditOrder('${order.line_user_id}', '${displayName}')" title="ç·¨è¼¯">âœï¸</button>
            </div>
            <div class="group-order-items">${itemsHtml}</div>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    function updateGroupPaymentsPanel(data) {
      const content = document.getElementById('payments-content');
      const payments = data.payments || {};
      const paymentEntries = Object.entries(payments);

      if (paymentEntries.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç„¡ä»˜æ¬¾è³‡æ–™</div>';
        return;
      }

      let html = '';
      paymentEntries.forEach(([userId, payment]) => {
        const displayName = payment.display_name || 'æœªçŸ¥';
        const amount = payment.amount || 0;
        const paidAmount = payment.paid_amount || 0;

        // åˆ¤æ–·ä»˜æ¬¾ç‹€æ…‹
        let statusText, statusClass;
        let showPaidBtn = false;
        let showRefundBtn = false;

        if (!payment.paid && paidAmount > 0) {
          statusText = `å¾…è£œ $${amount - paidAmount}`;
          statusClass = 'partial';
          showPaidBtn = true;
        } else if (payment.note && payment.note.startsWith('å¾…é€€')) {
          statusText = payment.note;
          statusClass = 'refund';
          showRefundBtn = true;
        } else if (payment.paid) {
          statusText = 'å·²ä»˜';
          statusClass = 'paid';
        } else {
          statusText = 'æœªä»˜';
          statusClass = 'pending';
          showPaidBtn = true;
        }

        html += `
          <div class="payment-item ${payment.paid ? 'paid' : ''}">
            <div>
              <span class="payment-user">${displayName}</span>
              <span class="payment-amount">$${amount}</span>
            </div>
            <div class="payment-actions">
              ${showPaidBtn ? `<button class="btn-paid" onclick="markGroupPaid('${userId}')">ç¢ºèªä»˜æ¬¾</button>` : ''}
              ${showRefundBtn ? `<button class="btn-refund" onclick="markGroupRefund('${userId}')">ç¢ºèªé€€æ¬¾</button>` : ''}
              <span class="payment-status ${statusClass}">${statusText}</span>
            </div>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    function updateGroupStatsPanel(data) {
      const content = document.getElementById('stats-content');
      const summary = data.summary || {};

      // å“é …çµ±è¨ˆ
      const itemCounts = {};
      (data.orders || []).forEach(order => {
        (order.items || []).forEach(item => {
          const key = item.note ? `${item.name}ï¼ˆ${item.note}ï¼‰` : item.name;
          itemCounts[key] = (itemCounts[key] || 0) + (item.quantity || 1);
        });
      });

      let html = `
        <div class="stats-overview">
          <div class="stat-item">
            <span class="stat-label">è¨‚å–®æ•¸</span>
            <span class="stat-value">${summary.order_count || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ç¸½é‡‘é¡</span>
            <span class="stat-value">$${summary.total_amount || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å·²æ”¶</span>
            <span class="stat-value stats-collected">$${summary.paid_amount || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å¾…æ”¶</span>
            <span class="stat-value stats-pending">$${summary.pending_amount || 0}</span>
          </div>
        </div>
      `;

      if (Object.keys(itemCounts).length > 0) {
        html += '<div class="stats-items-title">ğŸ“¦ å“é …çµ±è¨ˆ</div>';
        html += '<div class="stats-items">';
        Object.entries(itemCounts)
          .sort((a, b) => b[1] - a[1])
          .forEach(([name, count]) => {
            html += `<div class="stats-item-row"><span>${name}</span><span>x${count}</span></div>`;
          });
        html += '</div>';
      }

      content.innerHTML = html;
    }

    // ç¾¤çµ„ä»˜æ¬¾æ“ä½œ
    async function markGroupPaid(userId) {
      if (!selectedGroupId) return;

      const confirmed = await showConfirmModal('ç¢ºå®šè¦æ¨™è¨˜æ­¤ä½¿ç”¨è€…å·²ä»˜æ¬¾å—ï¼Ÿ', 'ğŸ’µ');
      if (!confirmed) return;

      try {
        const res = await fetch(`/api/super-admin/groups/${selectedGroupId}/payments/${userId}/mark-paid`, {
          method: 'POST'
        });
        const data = await res.json();

        if (data.success) {
          showNotification('å·²ç¢ºèªä»˜æ¬¾');
          loadGroupOrders();
        } else {
          showNotification('æ“ä½œå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        console.error('æ¨™è¨˜ä»˜æ¬¾å¤±æ•—:', err);
        showNotification('æ“ä½œå¤±æ•—');
      }
    }

    async function markGroupRefund(userId) {
      if (!selectedGroupId) return;

      const confirmed = await showConfirmModal('ç¢ºå®šè¦æ¨™è¨˜å·²é€€æ¬¾å—ï¼Ÿ', 'ğŸ’¸');
      if (!confirmed) return;

      try {
        const res = await fetch(`/api/super-admin/groups/${selectedGroupId}/payments/${userId}/refund`, {
          method: 'POST'
        });
        const data = await res.json();

        if (data.success) {
          showNotification('å·²ç¢ºèªé€€æ¬¾');
          loadGroupOrders();
        } else {
          showNotification('æ“ä½œå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        console.error('æ¨™è¨˜é€€æ¬¾å¤±æ•—:', err);
        showNotification('æ“ä½œå¤±æ•—');
      }
    }

    // === ä»£ç†é»é¤ ===
    function openProxyOrder() {
      if (!selectedGroupId || !currentGroupOrders) return;

      // å¡«å……ä½¿ç”¨è€…ä¸‹æ‹‰é¸å–®ï¼ˆå¾ç¾æœ‰è¨‚å–®ä¸­å–å¾—ï¼‰
      const userSelect = document.getElementById('proxy-user-select');
      let userHtml = '<option value="">-- é¸æ“‡ä½¿ç”¨è€… --</option>';
      userHtml += '<option value="__new__">+ æ–°å¢ä½¿ç”¨è€…</option>';

      const seenUsers = new Set();
      (currentGroupOrders.orders || []).forEach(order => {
        if (!seenUsers.has(order.line_user_id)) {
          seenUsers.add(order.line_user_id);
          userHtml += `<option value="${order.line_user_id}" data-name="${order.display_name}">${order.display_name}</option>`;
        }
      });
      userSelect.innerHTML = userHtml;

      // å¡«å……é¤é»ä¸‹æ‹‰é¸å–®
      updateProxyItemSelect();

      document.getElementById('proxy-order-modal').style.display = 'flex';
    }

    function closeProxyOrder() {
      document.getElementById('proxy-order-modal').style.display = 'none';
      document.getElementById('new-user-name').style.display = 'none';
      document.getElementById('new-user-name').value = '';
      document.getElementById('proxy-quantity').value = '1';
      document.getElementById('proxy-note').value = '';
    }

    function updateProxyItemSelect() {
      const select = document.getElementById('proxy-item-select');
      let html = '<option value="">-- é¸æ“‡é¤é» --</option>';

      // å¾ä»Šæ—¥åº—å®¶èœå–®å–å¾—å“é …
      todayStores.forEach(storeData => {
        const store = storeData.store;
        const menu = storeData.menu;

        if (menu && menu.categories) {
          menu.categories.forEach(cat => {
            (cat.items || []).forEach(item => {
              const price = item.price || 0;
              html += `<option value="${item.name}" data-price="${price}">${item.name} $${price}</option>`;
            });
          });
        }
      });

      select.innerHTML = html;
    }

    // è™•ç†ä½¿ç”¨è€…é¸æ“‡è®Šæ›´
    document.getElementById('proxy-user-select').addEventListener('change', (e) => {
      const newUserInput = document.getElementById('new-user-name');
      if (e.target.value === '__new__') {
        newUserInput.style.display = 'block';
      } else {
        newUserInput.style.display = 'none';
      }
    });

    async function submitProxyOrder() {
      const userSelect = document.getElementById('proxy-user-select');
      const itemSelect = document.getElementById('proxy-item-select');
      const quantity = parseInt(document.getElementById('proxy-quantity').value) || 1;
      const note = document.getElementById('proxy-note').value.trim();

      // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
      let lineUserId = userSelect.value;
      let displayName = '';

      if (lineUserId === '__new__') {
        displayName = document.getElementById('new-user-name').value.trim();
        if (!displayName) {
          alert('è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±');
          return;
        }
        // æ–°ä½¿ç”¨è€…ï¼šç”Ÿæˆä¸€å€‹è‡¨æ™‚ ID
        lineUserId = 'proxy_' + Date.now();
      } else if (!lineUserId) {
        alert('è«‹é¸æ“‡ä½¿ç”¨è€…');
        return;
      } else {
        displayName = userSelect.options[userSelect.selectedIndex].dataset.name || '';
      }

      // å–å¾—é¤é»
      const itemName = itemSelect.value;
      if (!itemName) {
        alert('è«‹é¸æ“‡é¤é»');
        return;
      }

      // å‘¼å« API
      try {
        const res = await fetch(`/api/super-admin/groups/${selectedGroupId}/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            line_user_id: lineUserId,
            display_name: displayName,
            items: [{ name: itemName, quantity: quantity, note: note }]
          })
        });

        const data = await res.json();

        if (data.success) {
          closeProxyOrder();
          loadGroupOrders();
          showNotification('ä»£ç†é»é¤æˆåŠŸ');
        } else {
          alert('é»é¤å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        console.error('ä»£ç†é»é¤å¤±æ•—:', err);
        alert('é»é¤å¤±æ•—');
      }
    }

    // === ç·¨è¼¯è¨‚å–® ===
    function openEditOrder(userId, displayName) {
      if (!selectedGroupId || !currentGroupOrders) return;

      editingUserId = userId;

      // æ‰¾åˆ°è©²ä½¿ç”¨è€…çš„è¨‚å–®
      const userOrder = currentGroupOrders.orders.find(o => o.line_user_id === userId);
      if (!userOrder) {
        alert('æ‰¾ä¸åˆ°è¨‚å–®');
        return;
      }

      document.getElementById('edit-order-user').textContent = `ğŸ‘¤ ${displayName}`;

      // é¡¯ç¤ºå“é …
      let html = '';
      userOrder.items.forEach((item, idx) => {
        html += `
          <div class="edit-item-row" data-idx="${idx}">
            <span class="edit-item-name">${item.name}</span>
            <input type="number" class="edit-item-qty" value="${item.quantity || 1}" min="1" max="10">
            <span class="edit-item-price">$${item.price || 0}</span>
            <button class="btn-icon btn-danger" onclick="removeEditItem(${idx})">ğŸ—‘ï¸</button>
          </div>
        `;
      });

      document.getElementById('edit-order-items').innerHTML = html;
      document.getElementById('edit-order-modal').style.display = 'flex';
    }

    function closeEditOrder() {
      document.getElementById('edit-order-modal').style.display = 'none';
      editingUserId = null;
    }

    function removeEditItem(idx) {
      const row = document.querySelector(`.edit-item-row[data-idx="${idx}"]`);
      if (row) row.remove();
    }

    async function saveEditedOrder() {
      if (!selectedGroupId || !editingUserId) return;

      // æ”¶é›†ç·¨è¼¯å¾Œçš„å“é …
      const items = [];
      document.querySelectorAll('.edit-item-row').forEach(row => {
        const name = row.querySelector('.edit-item-name').textContent;
        const quantity = parseInt(row.querySelector('.edit-item-qty').value) || 1;
        items.push({ name, quantity });
      });

      if (items.length === 0) {
        // æ²’æœ‰å“é …ï¼Œç­‰æ–¼åˆªé™¤è¨‚å–®
        await deleteEntireOrder();
        return;
      }

      try {
        const res = await fetch(`/api/super-admin/groups/${selectedGroupId}/orders/${editingUserId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });

        const data = await res.json();

        if (data.success) {
          closeEditOrder();
          loadGroupOrders();
          showNotification('è¨‚å–®å·²æ›´æ–°');
        } else {
          alert('æ›´æ–°å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        console.error('æ›´æ–°è¨‚å–®å¤±æ•—:', err);
        alert('æ›´æ–°å¤±æ•—');
      }
    }

    async function deleteEntireOrder() {
      if (!selectedGroupId || !editingUserId) return;

      const confirmed = await showConfirmModal('ç¢ºå®šè¦åˆªé™¤æ•´ç­†è¨‚å–®å—ï¼Ÿ', 'ğŸ—‘ï¸');
      if (!confirmed) return;

      try {
        const res = await fetch(`/api/super-admin/groups/${selectedGroupId}/orders/${editingUserId}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (data.success) {
          closeEditOrder();
          loadGroupOrders();
          showNotification('è¨‚å–®å·²åˆªé™¤');
        } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    function toggleStoreMenu(menuId) {
      const menuEl = document.getElementById(menuId);
      const index = menuId.replace('store-menu-', '');
      const toggleEl = document.getElementById(`toggle-${index}`);

      if (menuEl.style.display === 'none') {
        menuEl.style.display = 'block';
        toggleEl.textContent = 'â–²';
      } else {
        menuEl.style.display = 'none';
        toggleEl.textContent = 'â–¼';
      }
    }

    // ç·¨è¼¯åº—å®¶èœå–®
    function editStoreMenu(storeId) {
      // æ‰¾åˆ°å°æ‡‰çš„åº—å®¶è³‡æ–™
      const storeData = allStores.find(s => s.store.id === storeId);
      if (!storeData) {
        alert('æ‰¾ä¸åˆ°åº—å®¶è³‡æ–™');
        return;
      }

      // è¨­å®šç·¨è¼¯æ¨¡å¼
      isEditMode = true;
      targetStoreId = storeId;

      // è¼‰å…¥ç¾æœ‰èœå–®åˆ°ç·¨è¼¯å™¨ï¼ˆæ·±æ‹·è²é¿å…ä¿®æ”¹åŸè³‡æ–™ï¼‰
      recognizedMenu = JSON.parse(JSON.stringify(storeData.menu || { categories: [] }));

      // é–‹å•Ÿç·¨è¼¯ç•«é¢ï¼Œç›´æ¥è·³åˆ°çµæœç·¨è¼¯æ­¥é©Ÿ
      document.getElementById('menu-upload-modal').style.display = 'flex';
      document.getElementById('upload-step').style.display = 'none';
      document.getElementById('recognizing-step').style.display = 'none';
      document.getElementById('result-step').style.display = 'block';

      // ç·¨è¼¯æ¨¡å¼ï¼šæŒ‰éˆ•é¡¯ç¤ºã€Œå–æ¶ˆã€
      document.getElementById('back-btn').textContent = 'å–æ¶ˆ';

      // é¡¯ç¤ºç·¨è¼¯ç•«é¢
      showRecognitionResult(recognizedMenu, []);
    }

    // è™•ç†å¯†ç¢¼ Enter éµ
    function handlePasswordKeyPress(event) {
      if (event.key === 'Enter') {
        verifyPassword();
      }
    }

    // é©—è­‰å¯†ç¢¼
    async function verifyPassword() {
      const password = document.getElementById('password-input').value;
      const errorMsg = document.getElementById('error-msg');

      try {
        const res = await fetch('/api/verify-admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (data.success) {
          // éš±è—å¯†ç¢¼è¼¸å…¥ï¼Œé¡¯ç¤ºç®¡ç†ä»‹é¢
          document.getElementById('password-section').style.display = 'none';
          document.getElementById('manager-section').style.display = 'block';
          document.getElementById('team-chat').style.display = 'flex';

          // é‡ç½® sessionï¼Œç¢ºä¿æ¯æ¬¡é€²å…¥éƒ½æ˜¯æ–°å°è©±
          await fetch('/api/session/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username, is_manager: true })
          });

          // è¼‰å…¥ç®¡ç†è³‡æ–™ä¸¦å–å¾—åå¥½ç¨±å‘¼
          const preferredName = await loadAdminData(username);
          loadAllStores();
          loadGroups();  // è¼‰å…¥ç¾¤çµ„åˆ—è¡¨

          // æ¸…ç©ºèŠå¤©è¨Šæ¯ï¼ˆé¿å…é‡è¤‡ç™»å…¥æ™‚ç´¯ç©è¨Šæ¯ï¼‰
          document.getElementById('chat-messages').innerHTML = '';

          // é¡¯ç¤ºæ­¡è¿è¨Šæ¯ï¼ˆä½¿ç”¨åå¥½ç¨±å‘¼ï¼‰
          const displayName = preferredName || 'æˆ‘å€‘';
          addMessage('assistant', `å“‡ä¿‚å‘·çˆ¸ï¼Œ${displayName}ä»Šå¤©è¦è¨‚å“ªå®¶åº—å‘¢ï¼Ÿ

å¯ä»¥ï¼š
â€¢ è¨­å®šä»Šæ—¥åº—å®¶ï¼ˆä¾‹ï¼šä»Šå¤©åƒä½³é¦™å‘³ä¾¿ç•¶ï¼‰
â€¢ æŸ¥çœ‹ä»Šæ—¥è¨‚å–®
â€¢ æŸ¥çœ‹ä»˜æ¬¾ç‹€æ…‹
â€¢ æ¨™è¨˜å·²ä»˜æ¬¾ï¼ˆä¾‹ï¼šå°æ˜å·²ä»˜æ¬¾ï¼‰

éœ€è¦å»ºè­°ï¼Ÿå•æˆ‘ã€Œä»Šå¤©è¨‚å“ªå®¶å¥½ï¼Ÿã€`);

          document.getElementById('message-input').focus();
          // ç¾¤çµ„å°è©±æœƒåœ¨é¸æ“‡ç¾¤çµ„æ™‚è¼‰å…¥ï¼Œé€™è£¡ä¸éœ€è¦é å…ˆè¼‰å…¥
        } else {
          errorMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤';
          errorMsg.style.display = 'block';
        }
      } catch (err) {
        errorMsg.textContent = 'é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        errorMsg.style.display = 'block';
        console.error(err);
      }
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', message);
      input.value = '';

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addMessage('assistant', 'è™•ç†ä¸­...');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            message: message,
            is_manager: true
          })
        });

        const data = await res.json();

        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(loadingId).remove();

        // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤ºä¸åŒè¨Šæ¯
        if (data.error) {
          if (data.error === 'timeout') {
            addMessage('assistant', 'æŠ±æ­‰ï¼Œå›æ‡‰è¶…æ™‚äº†ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
          } else {
            // parse_errorã€no_response ç­‰ï¼šé¡¯ç¤º AI çš„å¯¦éš›å›æ‡‰
            addMessage('assistant', data.message || 'æ”¶åˆ°æŒ‡ä»¤ã€‚');
          }
        } else {
          // æ­£å¸¸é¡¯ç¤º AI å›æ‡‰
          addMessage('assistant', data.message || 'æ”¶åˆ°æŒ‡ä»¤ã€‚');
        }

        // è™•ç†å‹•ä½œçµæœ
        const results = data.action_results || [];
        let needReloadStores = false;
        let needReloadAdmin = false;

        results.forEach(result => {
          if (result.success) {
            let resultMsg = 'âœ… æ“ä½œæˆåŠŸï¼';
            if (result.event === 'store_changed') {
              resultMsg = `âœ… å·²è¨­å®šä»Šæ—¥åº—å®¶ï¼š${result.store_name || ''}`;
              needReloadAdmin = true;
            }
            // å¦‚æœæ˜¯åº—å®¶æˆ–èœå–®ç›¸é—œæ“ä½œï¼Œæ¨™è¨˜éœ€è¦é‡æ–°è¼‰å…¥
            if (result.store || result.menu) {
              needReloadStores = true;
            }
            addMessage('assistant', resultMsg);
          } else if (result.error) {
            addMessage('assistant', `âŒ æ“ä½œå¤±æ•—ï¼š${result.error}`);
          }
        });

        // æ‰¹æ¬¡é‡æ–°è¼‰å…¥
        if (needReloadAdmin) loadAdminData();
        if (needReloadStores) loadAllStores();

      } catch (err) {
        document.getElementById(loadingId).remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        console.error(err);
      }
    }

    // è¨Šæ¯ ID è¨ˆæ•¸å™¨
    let messageIdCounter = 0;

    // æ·»åŠ è¨Šæ¯åˆ°å°è©±å€åŸŸ
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const id = 'msg-' + Date.now() + '-' + (messageIdCounter++);

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;

      if (role === 'assistant') {
        msgEl.innerHTML = `
          <div class="message-avatar">
            <img src="/static/images/jaba-icon.png" alt="å‘·çˆ¸" class="avatar-icon">
          </div>
          <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
        `;
      } else {
        msgEl.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;
      }

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // ç›£è¯äº‹ä»¶
    socket.on('order_created', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      }
      // é‡æ–°è¼‰å…¥ä»˜æ¬¾è³‡æ–™
      loadAdminData();
      showNotification(`${data.username} è¨‚äº†ä¾¿ç•¶ï¼`);
      sendBrowserNotification('æ–°è¨‚å–®', `${data.username} è¨‚äº†ä¾¿ç•¶ï¼`, 'order-created');
    });

    socket.on('order_cancelled', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      }
      // é‡æ–°è¼‰å…¥ä»˜æ¬¾è³‡æ–™
      loadAdminData();
      showNotification(`${data.username} å–æ¶ˆäº†è¨‚å–®`);
      sendBrowserNotification('è¨‚å–®å–æ¶ˆ', `${data.username} å–æ¶ˆäº†è¨‚å–®`, 'order-cancelled');
    });

    socket.on('orders_cleared', (data) => {
      // æ¸…ç©ºè¨‚å–®å’Œä»˜æ¬¾é¢æ¿
      updateOrdersPanel(null);
      updatePaymentsPanel(null);
      showNotification('æ‰€æœ‰è¨‚å–®å·²æ¸…é™¤');
    });

    socket.on('store_changed', (data) => {
      const storeName = data.store_name || 'æ–°åº—å®¶';
      // é‡æ–°è¼‰å…¥ç®¡ç†è³‡æ–™
      loadAdminData();
      showNotification(`ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`);
    });

    socket.on('payment_updated', (data) => {
      // é‡æ–°è¼‰å…¥ä»˜æ¬¾è³‡æ–™
      loadAdminData();
      showNotification('ä»˜æ¬¾ç‹€æ…‹å·²æ›´æ–°');
    });

    // === ç¾¤çµ„é»é¤äº‹ä»¶ ===
    socket.on('group_session_started', async (data) => {
      // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨ï¼ˆä¿æŒé¸ä¸­ç‹€æ…‹ï¼‰
      await loadGroups();
      // å¦‚æœæ˜¯ç•¶å‰é¸ä¸­çš„ç¾¤çµ„ï¼Œé‡æ–°è¼‰å…¥è¨‚å–®ï¼ˆé–‹å–®æœƒæ¸…ç©ºè¨‚å–®ï¼‰
      if (selectedGroupId === data.group_id) {
        await reloadCurrentGroupOrders();
      }
      showNotification(`ç¾¤çµ„é»é¤å·²é–‹å§‹ï¼ˆ${data.started_by || ''}ï¼‰`);
    });

    socket.on('group_order_updated', async (data) => {
      // å¦‚æœæ˜¯ç•¶å‰é¸ä¸­çš„ç¾¤çµ„ï¼Œé‡æ–°è¼‰å…¥è¨‚å–®
      if (selectedGroupId === data.group_id) {
        await reloadCurrentGroupOrders();
      }
      // æ›´æ–°ç¾¤çµ„åˆ—è¡¨ï¼ˆè¨‚å–®æ•¸é‡å¯èƒ½è®Šäº†ï¼Œä½†ä¿æŒé¸ä¸­ç‹€æ…‹ï¼‰
      await loadGroups();
      showNotification(`${data.user || 'ä½¿ç”¨è€…'} æ›´æ–°äº†è¨‚å–®`);
    });

    socket.on('group_session_ended', async (data) => {
      // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨ï¼ˆä¿æŒé¸ä¸­ç‹€æ…‹ï¼‰
      await loadGroups();
      // å¦‚æœæ˜¯ç•¶å‰é¸ä¸­çš„ç¾¤çµ„ï¼Œé‡æ–°è¼‰å…¥è¨‚å–®
      if (selectedGroupId === data.group_id) {
        await reloadCurrentGroupOrders();
      }
      showNotification(`ç¾¤çµ„é»é¤å·²çµæŸï¼ˆ${data.order_count || 0} ç­†è¨‚å–®ï¼Œ$${data.total_amount || 0}ï¼‰`);
    });

    // === ç¢ºèªå°è©±æ¡† ===
    let confirmModalResolve = null;

    function showConfirmModal(message, icon = 'ğŸ’°') {
      document.getElementById('confirm-modal-icon').textContent = icon;
      document.getElementById('confirm-modal-message').textContent = message;
      document.getElementById('confirm-modal').style.display = 'flex';

      return new Promise((resolve) => {
        confirmModalResolve = resolve;
        document.getElementById('confirm-modal-ok').onclick = () => {
          document.getElementById('confirm-modal').style.display = 'none';
          confirmModalResolve = null;
          resolve(true);
        };
      });
    }

    function closeConfirmModal() {
      document.getElementById('confirm-modal').style.display = 'none';
      if (confirmModalResolve) {
        confirmModalResolve(false);
        confirmModalResolve = null;
      }
    }

    // ç¢ºèªä»˜æ¬¾
    async function confirmPaid(targetUsername) {
      const confirmed = await showConfirmModal(`ç¢ºå®šè¦æ¨™è¨˜ ${targetUsername} å·²ä»˜æ¬¾å—ï¼Ÿ`, 'ğŸ’µ');
      if (!confirmed) return;

      try {
        const res = await fetch('/api/mark-paid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: targetUsername })
        });

        const data = await res.json();
        if (data.success) {
          showNotification(`å·²ç¢ºèª ${targetUsername} ä»˜æ¬¾`);
          loadAdminData();
        } else {
          showNotification(`ä»˜æ¬¾å¤±æ•—ï¼š${data.error}`);
        }
      } catch (err) {
        console.error('ä»˜æ¬¾å¤±æ•—:', err);
        showNotification('ä»˜æ¬¾å¤±æ•—');
      }
    }

    // ç¢ºèªé€€æ¬¾
    async function confirmRefund(targetUsername) {
      const confirmed = await showConfirmModal(`ç¢ºå®šè¦æ¨™è¨˜å·²é€€æ¬¾çµ¦ ${targetUsername} å—ï¼Ÿ`, 'ğŸ’¸');
      if (!confirmed) return;

      try {
        const res = await fetch('/api/refund', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: targetUsername })
        });

        const data = await res.json();
        if (data.success) {
          showNotification(`å·²ç¢ºèªé€€æ¬¾çµ¦ ${targetUsername}`);
          loadAdminData();
        } else {
          showNotification(`é€€æ¬¾å¤±æ•—ï¼š${data.error}`);
        }
      } catch (err) {
        console.error('é€€æ¬¾å¤±æ•—:', err);
        showNotification('é€€æ¬¾å¤±æ•—');
      }
    }

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // === ç¾¤çµ„è¨è«–å€ï¼ˆé¡¯ç¤ºé¸å®šç¾¤çµ„çš„ LINE å°è©±ï¼‰ ===
    let teamChatOpen = true;  // é è¨­å±•é–‹
    let unreadCount = 0;

    function toggleTeamChat() {
      const chatEl = document.getElementById('team-chat');
      teamChatOpen = !teamChatOpen;

      if (teamChatOpen) {
        chatEl.classList.remove('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–¼';
        unreadCount = 0;
        updateUnreadBadge();
        const messagesEl = document.getElementById('team-chat-messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        chatEl.classList.add('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–²';
      }
    }

    function updateUnreadBadge() {
      const badge = document.getElementById('unread-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // æ›´æ–°ç¾¤çµ„è¨è«–å€æ¨™é¡Œ
    function updateGroupChatTitle(groupName) {
      const titleEl = document.getElementById('group-chat-title');
      if (groupName) {
        titleEl.textContent = `ğŸ’¬ ${groupName} ç¾¤çµ„è¨è«–`;
      } else {
        titleEl.textContent = 'ğŸ’¬ è«‹é¸æ“‡ç¾¤çµ„';
      }
    }

    // æ·»åŠ ç¾¤çµ„å°è©±è¨Šæ¯åˆ°è¨è«–å€
    function addGroupChatMessage(msg) {
      const messagesEl = document.getElementById('team-chat-messages');

      // ç§»é™¤ç©ºæç¤º
      const emptyHint = messagesEl.querySelector('.chat-empty-hint');
      if (emptyHint) emptyHint.remove();

      const isJaba = msg.role === 'assistant' || msg.username === 'å‘·çˆ¸';

      const msgEl = document.createElement('div');
      msgEl.className = `team-chat-message ${isJaba ? 'jaba' : ''}`;

      const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
        hour: '2-digit',
        minute: '2-digit'
      }) : '';

      msgEl.innerHTML = `
        <div class="team-chat-message-header">
          <span class="team-chat-message-user">${msg.username}</span>
          <span class="team-chat-message-time">${time}</span>
        </div>
        <div class="team-chat-message-content">${(msg.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
      `;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // è¼‰å…¥ç¾¤çµ„å°è©±è¨˜éŒ„
    async function loadGroupChat(groupId) {
      const messagesEl = document.getElementById('team-chat-messages');

      if (!groupId) {
        messagesEl.innerHTML = '<div class="chat-empty-hint">é¸æ“‡ç¾¤çµ„ä»¥æŸ¥çœ‹å°è©±è¨˜éŒ„</div>';
        updateGroupChatTitle(null);
        return;
      }

      try {
        const res = await fetch(`/api/super-admin/groups/${groupId}/chat`);
        const data = await res.json();

        // æ›´æ–°æ¨™é¡Œ
        const groupName = data.group_name || `ç¾¤çµ„ ...${groupId.slice(-8)}`;
        updateGroupChatTitle(groupName);

        // æ¸…ç©ºä¸¦è¼‰å…¥è¨Šæ¯
        messagesEl.innerHTML = '';

        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => addGroupChatMessage(msg));
        } else {
          messagesEl.innerHTML = '<div class="chat-empty-hint">å°šç„¡å°è©±è¨˜éŒ„</div>';
        }
      } catch (err) {
        console.error('è¼‰å…¥ç¾¤çµ„å°è©±å¤±æ•—:', err);
        messagesEl.innerHTML = '<div class="chat-empty-hint">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // ç›£è½ç¾¤çµ„å°è©±æ›´æ–°äº‹ä»¶
    socket.on('group_chat_updated', (data) => {
      // åªæ›´æ–°ç•¶å‰é¸ä¸­çš„ç¾¤çµ„
      if (data.group_id === selectedGroupId) {
        addGroupChatMessage(data.message);
        if (!teamChatOpen) {
          unreadCount++;
          updateUnreadBadge();
        }
      }
    });

    // === èœå–®åœ–ç‰‡è¾¨è­˜ ===
    let selectedImage = null;
    let recognizedMenu = null;
    let targetStoreId = null;
    let isEditMode = false;  // æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆç›´æ¥ç·¨è¼¯ç¾æœ‰èœå–®ï¼‰
    let menuDiff = null;     // å·®ç•°æ¯”å°çµæœ
    let existingMenu = null; // ç¾æœ‰èœå–®
    let isDiffMode = false;  // æ˜¯å¦ç‚ºå·®ç•°é è¦½æ¨¡å¼

    function openMenuUpload() {
      document.getElementById('menu-upload-modal').style.display = 'flex';
      // å¡«å……åº—å®¶ä¸‹æ‹‰é¸å–®
      const select = document.getElementById('target-store-select');
      select.innerHTML = '<option value="">-- é¸æ“‡ç¾æœ‰åº—å®¶ --</option><option value="__new__">+ æ–°å¢åº—å®¶</option>';
      allStores.forEach(storeData => {
        const store = storeData.store;
        select.innerHTML += `<option value="${store.id}">${store.name}</option>`;
      });
      // é‡ç½®ç‹€æ…‹
      resetUploadState();
    }

    function closeMenuUpload() {
      document.getElementById('menu-upload-modal').style.display = 'none';
      resetUploadState();
    }

    function resetUploadState() {
      selectedImage = null;
      recognizedMenu = null;
      targetStoreId = null;
      isEditMode = false;
      menuDiff = null;
      existingMenu = null;
      isDiffMode = false;
      document.getElementById('upload-step').style.display = 'block';
      document.getElementById('recognizing-step').style.display = 'none';
      document.getElementById('result-step').style.display = 'none';
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('upload-area').style.display = 'block';
      document.getElementById('recognize-btn').disabled = true;
      document.getElementById('menu-image-input').value = '';
      document.getElementById('target-store-select').value = '';
      document.getElementById('new-store-name').style.display = 'none';
      document.getElementById('new-store-name').value = '';
      document.getElementById('back-btn').textContent = 'é‡æ–°ä¸Šå‚³';
    }

    // è™•ç†åº—å®¶é¸æ“‡è®Šæ›´
    document.getElementById('target-store-select').addEventListener('change', (e) => {
      const newStoreInput = document.getElementById('new-store-name');
      if (e.target.value === '__new__') {
        newStoreInput.style.display = 'block';
      } else {
        newStoreInput.style.display = 'none';
      }
      updateRecognizeBtn();
    });

    // è™•ç†åœ–ç‰‡é¸æ“‡
    function handleImageSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        selectedImage = e.target.result;
        document.getElementById('preview-image').src = selectedImage;
        document.getElementById('upload-preview').style.display = 'block';
        document.getElementById('upload-area').style.display = 'none';
        updateRecognizeBtn();
      };
      reader.readAsDataURL(file);
    }

    function clearImage() {
      selectedImage = null;
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('upload-area').style.display = 'block';
      document.getElementById('menu-image-input').value = '';
      updateRecognizeBtn();
    }

    function updateRecognizeBtn() {
      const select = document.getElementById('target-store-select');
      const newStoreName = document.getElementById('new-store-name').value.trim();
      const hasStore = select.value && (select.value !== '__new__' || newStoreName);
      document.getElementById('recognize-btn').disabled = !selectedImage || !hasStore;
    }

    document.getElementById('new-store-name').addEventListener('input', updateRecognizeBtn);

    // æ‹–æ”¾æ”¯æ´
    const uploadArea = document.getElementById('upload-area');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        document.getElementById('menu-image-input').files = e.dataTransfer.files;
        handleImageSelect({ target: { files: e.dataTransfer.files } });
      }
    });

    // é–‹å§‹è¾¨è­˜
    function showUploadError(message) {
      const errorEl = document.getElementById('upload-error');
      errorEl.innerHTML = `<div class="error-box">âŒ ${message}</div>`;
      errorEl.style.display = 'block';
    }

    function hideUploadError() {
      const errorEl = document.getElementById('upload-error');
      errorEl.style.display = 'none';
    }

    async function recognizeMenu() {
      const select = document.getElementById('target-store-select');
      const storeId = select.value === '__new__' ? null : select.value;
      const storeName = select.value === '__new__' ? document.getElementById('new-store-name').value.trim() : null;

      hideUploadError();
      document.getElementById('upload-step').style.display = 'none';
      document.getElementById('recognizing-step').style.display = 'block';

      try {
        const res = await fetch('/api/recognize-menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: storeId,
            store_name: storeName,
            image: selectedImage
          })
        });

        // æª¢æŸ¥å›æ‡‰ç‹€æ…‹
        if (!res.ok) {
          let errorMsg = `ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`;
          try {
            const errData = await res.json();
            errorMsg = errData.error || errorMsg;
          } catch (e) {
            // ç„¡æ³•è§£æ JSONï¼Œå¯èƒ½æ˜¯ HTML éŒ¯èª¤é é¢
          }
          showUploadError(errorMsg);
          document.getElementById('recognizing-step').style.display = 'none';
          document.getElementById('upload-step').style.display = 'block';
          return;
        }

        const data = await res.json();

        if (data.error) {
          console.error('è¾¨è­˜éŒ¯èª¤:', data.error);
          showUploadError(data.error);
          document.getElementById('recognizing-step').style.display = 'none';
          document.getElementById('upload-step').style.display = 'block';
          return;
        }

        targetStoreId = data.store_id;
        recognizedMenu = data.recognized_menu;
        existingMenu = data.existing_menu;
        menuDiff = data.diff;

        // åˆ¤æ–·æ˜¯å¦ä½¿ç”¨å·®ç•°é è¦½æ¨¡å¼ï¼ˆæœ‰ç¾æœ‰èœå–®ä¸”æœ‰å·®ç•°ï¼‰
        isDiffMode = existingMenu && menuDiff &&
          (menuDiff.added.length > 0 || menuDiff.modified.length > 0 || menuDiff.removed.length > 0);

        // é¡¯ç¤ºçµæœ
        if (isDiffMode) {
          showDiffPreview(menuDiff, data.warnings);
        } else {
          showRecognitionResult(data.recognized_menu, data.warnings);
        }

      } catch (err) {
        console.error('è¾¨è­˜å¤±æ•—:', err);
        showUploadError('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        document.getElementById('recognizing-step').style.display = 'none';
        document.getElementById('upload-step').style.display = 'block';
      }
    }

    function showRecognitionResult(menu, warnings) {
      document.getElementById('recognizing-step').style.display = 'none';
      document.getElementById('result-step').style.display = 'block';

      // é¡¯ç¤ºè­¦å‘Š
      const warningsEl = document.getElementById('result-warnings');
      if (warnings && warnings.length > 0) {
        warningsEl.innerHTML = '<div class="warning-box">âš ï¸ ' + warnings.join('<br>') + '</div>';
      } else {
        warningsEl.innerHTML = '';
      }

      // ç”Ÿæˆç·¨è¼¯è¡¨æ ¼
      const editor = document.getElementById('result-editor');
      let html = '';

      if (menu && menu.categories) {
        menu.categories.forEach((category, catIdx) => {
          html += `
            <div class="result-category" data-cat-idx="${catIdx}">
              <div class="result-category-header">
                <input type="text" class="cat-name-input" value="${category.name}" data-cat-idx="${catIdx}">
                <button class="btn-icon" onclick="addItem(${catIdx})" title="æ–°å¢å“é …">â•</button>
                <button class="btn-icon btn-danger" onclick="removeCategory(${catIdx})" title="åˆªé™¤åˆ†é¡">ğŸ—‘ï¸</button>
              </div>
              <div class="result-items" id="cat-items-${catIdx}">
          `;

          if (category.items) {
            category.items.forEach((item, itemIdx) => {
              html += generateItemRow(catIdx, itemIdx, item);
            });
          }

          html += `
              </div>
            </div>
          `;
        });
      }

      html += '<button class="btn btn-secondary" onclick="addCategory()">+ æ–°å¢åˆ†é¡</button>';

      // å¦‚æœæœ‰å·®ç•°è³‡æ–™ï¼Œé¡¯ç¤ºè¿”å›å·®ç•°é è¦½çš„æŒ‰éˆ•
      if (menuDiff && (menuDiff.added.length > 0 || menuDiff.modified.length > 0 || menuDiff.removed.length > 0)) {
        html += '<button class="btn btn-link" onclick="switchToDiffPreview()">â† è¿”å›å·®ç•°é è¦½æ¨¡å¼</button>';
      }

      editor.innerHTML = html;
    }

    // å·®ç•°é è¦½æ¨¡å¼
    function showDiffPreview(diff, warnings) {
      document.getElementById('recognizing-step').style.display = 'none';
      document.getElementById('result-step').style.display = 'block';

      // é¡¯ç¤ºè­¦å‘Š
      const warningsEl = document.getElementById('result-warnings');
      if (warnings && warnings.length > 0) {
        warningsEl.innerHTML = '<div class="warning-box">âš ï¸ ' + warnings.join('<br>') + '</div>';
      } else {
        warningsEl.innerHTML = '';
      }

      // ç”Ÿæˆå·®ç•°é è¦½
      const editor = document.getElementById('result-editor');
      let html = '<div class="diff-preview">';

      // æ–°å¢å“é …
      if (diff.added.length > 0) {
        html += `
          <div class="diff-section diff-added">
            <div class="diff-section-header">
              <span class="diff-icon">âœ…</span>
              <span>æ–°å¢å“é … (${diff.added.length})</span>
              <label class="diff-select-all">
                <input type="checkbox" checked onchange="toggleDiffSection(this, 'added')"> å…¨é¸
              </label>
            </div>
            <div class="diff-items">
        `;
        diff.added.forEach((d, idx) => {
          const item = d.item;
          const priceDisplay = item.variants && item.variants.length > 0
            ? item.variants.map(v => `${v.name} $${v.price}`).join(' / ')
            : `$${item.price}`;
          const promoLabel = item.promo ? `<span class="promo-tag">${item.promo.label}</span>` : '';
          html += `
            <div class="diff-item" data-type="added" data-idx="${idx}">
              <label>
                <input type="checkbox" class="diff-checkbox" data-type="added" data-idx="${idx}" checked>
                <span class="diff-marker added">ğŸŸ¢</span>
                <span class="diff-item-name">${item.name}</span>
                <span class="diff-item-price">${priceDisplay}</span>
                ${promoLabel}
                <span class="diff-item-category">[${d.category}]</span>
              </label>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // ä¿®æ”¹å“é …
      if (diff.modified.length > 0) {
        html += `
          <div class="diff-section diff-modified">
            <div class="diff-section-header">
              <span class="diff-icon">âš ï¸</span>
              <span>ä¿®æ”¹å“é … (${diff.modified.length})</span>
              <label class="diff-select-all">
                <input type="checkbox" checked onchange="toggleDiffSection(this, 'modified')"> å…¨é¸
              </label>
            </div>
            <div class="diff-items">
        `;
        diff.modified.forEach((d, idx) => {
          const changes = d.changes.join('ã€');
          const newItem = d.new_item;
          const promoLabel = newItem.promo ? `<span class="promo-tag">${newItem.promo.label}</span>` : '';
          html += `
            <div class="diff-item" data-type="modified" data-idx="${idx}">
              <label>
                <input type="checkbox" class="diff-checkbox" data-type="modified" data-idx="${idx}" checked>
                <span class="diff-marker modified">ğŸŸ¡</span>
                <span class="diff-item-name">${newItem.name}</span>
                ${promoLabel}
                <span class="diff-item-changes">${changes}</span>
              </label>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // å¯åˆªé™¤å“é …
      if (diff.removed.length > 0) {
        html += `
          <div class="diff-section diff-removed">
            <div class="diff-section-header">
              <span class="diff-icon">ğŸ—‘ï¸</span>
              <span>å¯åˆªé™¤å“é … (${diff.removed.length})</span>
              <label class="diff-select-all">
                <input type="checkbox" onchange="toggleDiffSection(this, 'removed')"> å…¨é¸
              </label>
            </div>
            <div class="diff-items">
        `;
        diff.removed.forEach((d, idx) => {
          const item = d.item;
          const priceDisplay = item.variants && item.variants.length > 0
            ? item.variants.map(v => `${v.name} $${v.price}`).join(' / ')
            : `$${item.price}`;
          html += `
            <div class="diff-item" data-type="removed" data-idx="${idx}">
              <label>
                <input type="checkbox" class="diff-checkbox" data-type="removed" data-idx="${idx}">
                <span class="diff-marker removed">ğŸ”´</span>
                <span class="diff-item-name">${item.name}</span>
                <span class="diff-item-price">${priceDisplay}</span>
                <span class="diff-item-hint">(æ–°èœå–®ä¸­æœªå‡ºç¾)</span>
              </label>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // æœªè®Šæ›´å“é …ï¼ˆæ‘ºç–Šé¡¯ç¤ºï¼‰
      if (diff.unchanged.length > 0) {
        html += `
          <div class="diff-section diff-unchanged">
            <div class="diff-section-header collapsed" onclick="toggleUnchangedSection()">
              <span class="diff-icon">âœ“</span>
              <span>æœªè®Šæ›´å“é … (${diff.unchanged.length})</span>
              <span class="diff-toggle" id="unchanged-toggle">â–¶</span>
            </div>
            <div class="diff-items" id="unchanged-items" style="display: none;">
        `;
        diff.unchanged.forEach(d => {
          html += `
            <div class="diff-item unchanged">
              <span class="diff-item-name">${d.item.name}</span>
              <span class="diff-item-category">[${d.category}]</span>
            </div>
          `;
        });
        html += '</div></div>';
      }

      html += '</div>';

      // åˆ‡æ›åˆ°å®Œæ•´ç·¨è¼¯æ¨¡å¼çš„æŒ‰éˆ•
      html += '<button class="btn btn-link" onclick="switchToFullEdit()">åˆ‡æ›åˆ°å®Œæ•´ç·¨è¼¯æ¨¡å¼</button>';

      editor.innerHTML = html;
    }

    function toggleDiffSection(checkbox, type) {
      document.querySelectorAll(`.diff-checkbox[data-type="${type}"]`).forEach(cb => {
        cb.checked = checkbox.checked;
      });
    }

    function toggleUnchangedSection() {
      const items = document.getElementById('unchanged-items');
      const toggle = document.getElementById('unchanged-toggle');
      if (items.style.display === 'none') {
        items.style.display = 'block';
        toggle.textContent = 'â–¼';
      } else {
        items.style.display = 'none';
        toggle.textContent = 'â–¶';
      }
    }

    function switchToFullEdit() {
      isDiffMode = false;
      showRecognitionResult(recognizedMenu, []);
    }

    function switchToDiffPreview() {
      if (menuDiff) {
        isDiffMode = true;
        showDiffPreview(menuDiff, []);
      }
    }

    function generateItemRow(catIdx, itemIdx, item) {
      const variants = item.variants || [];
      let variantsHtml = '';

      if (variants.length > 0) {
        variantsHtml = variants.map((v, vIdx) => `
          <div class="variant-row" data-var-idx="${vIdx}">
            <input type="text" class="variant-name" value="${v.name || ''}" placeholder="å°ºå¯¸">
            <span>$</span>
            <input type="number" class="variant-price" value="${v.price || 0}" placeholder="åƒ¹æ ¼">
            <button class="btn-icon btn-danger btn-sm" onclick="removeVariant(${catIdx}, ${itemIdx}, ${vIdx})">âœ•</button>
          </div>
        `).join('');
      }

      return `
        <div class="result-item" data-cat-idx="${catIdx}" data-item-idx="${itemIdx}">
          <div class="item-main-row">
            <input type="text" class="item-name" value="${item.name || ''}" placeholder="å“å">
            <input type="number" class="item-price" value="${item.price || 0}" placeholder="é è¨­åƒ¹æ ¼">
            <input type="text" class="item-desc" value="${item.description || ''}" placeholder="èªªæ˜">
            <button class="btn-icon btn-danger" onclick="removeItem(${catIdx}, ${itemIdx})">ğŸ—‘ï¸</button>
          </div>
          <div class="item-variants">
            ${variantsHtml}
            <button class="btn-link btn-add-variant" onclick="addVariant(${catIdx}, ${itemIdx})">+ æ–°å¢å°ºå¯¸</button>
          </div>
        </div>
      `;
    }

    function addCategory() {
      recognizedMenu.categories.push({ name: 'æ–°åˆ†é¡', items: [] });
      showRecognitionResult(recognizedMenu, []);
    }

    function removeCategory(catIdx) {
      recognizedMenu.categories.splice(catIdx, 1);
      showRecognitionResult(recognizedMenu, []);
    }

    function addItem(catIdx) {
      recognizedMenu.categories[catIdx].items.push({
        id: `item-new-${Date.now()}`,
        name: '',
        price: 0,
        description: '',
        available: true
      });
      showRecognitionResult(recognizedMenu, []);
    }

    function removeItem(catIdx, itemIdx) {
      recognizedMenu.categories[catIdx].items.splice(itemIdx, 1);
      showRecognitionResult(recognizedMenu, []);
    }

    function addVariant(catIdx, itemIdx) {
      const item = recognizedMenu.categories[catIdx].items[itemIdx];
      if (!item.variants) item.variants = [];
      item.variants.push({ name: '', price: 0 });
      showRecognitionResult(recognizedMenu, []);
    }

    function removeVariant(catIdx, itemIdx, varIdx) {
      const item = recognizedMenu.categories[catIdx].items[itemIdx];
      if (item.variants) {
        item.variants.splice(varIdx, 1);
        if (item.variants.length === 0) delete item.variants;
      }
      showRecognitionResult(recognizedMenu, []);
    }

    function backToUpload() {
      if (isEditMode) {
        // ç·¨è¼¯æ¨¡å¼ï¼šç›´æ¥é—œé–‰å°è©±æ¡†
        closeMenuUpload();
      } else {
        // è¾¨è­˜æ¨¡å¼ï¼šè¿”å›ä¸Šå‚³æ­¥é©Ÿ
        document.getElementById('result-step').style.display = 'none';
        document.getElementById('upload-step').style.display = 'block';
      }
    }

    // å„²å­˜è¾¨è­˜çµæœ
    async function saveRecognizedMenu() {
      // å·®ç•°æ¨¡å¼å„²å­˜
      if (isDiffMode && menuDiff) {
        await saveDiffMenu();
        return;
      }

      // å¾ DOM æ”¶é›†ç·¨è¼¯å¾Œçš„è³‡æ–™
      const categories = [];
      document.querySelectorAll('.result-category').forEach((catEl, catIdx) => {
        const catName = catEl.querySelector('.cat-name-input').value.trim() || 'æœªå‘½å';
        const items = [];

        catEl.querySelectorAll('.result-item').forEach((itemEl, itemIdx) => {
          const name = itemEl.querySelector('.item-name').value.trim();
          const price = parseInt(itemEl.querySelector('.item-price').value) || 0;
          const desc = itemEl.querySelector('.item-desc').value.trim();

          // æ”¶é›†å°ºå¯¸è®Šé«”
          const variants = [];
          itemEl.querySelectorAll('.variant-row').forEach(varEl => {
            const varName = varEl.querySelector('.variant-name').value.trim();
            const varPrice = parseInt(varEl.querySelector('.variant-price').value) || 0;
            if (varName) {
              variants.push({ name: varName, price: varPrice });
            }
          });

          if (name) {
            const item = {
              id: `item-${catIdx}-${itemIdx}`,
              name: name,
              price: price,
              description: desc,
              available: true
            };
            if (variants.length > 0) {
              item.variants = variants;
            }
            items.push(item);
          }
        });

        if (items.length > 0 || catName) {
          categories.push({ name: catName, items: items });
        }
      });

      // å‘¼å« API å„²å­˜
      try {
        const res = await fetch('/api/save-menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: targetStoreId,
            categories: categories
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'å„²å­˜å¤±æ•—');
        }

        closeMenuUpload();
        loadAllStores();
        showNotification('èœå–®å·²å„²å­˜ï¼');

      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
      }
    }

    // å·®ç•°æ¨¡å¼å„²å­˜
    async function saveDiffMenu() {
      const applyItems = [];
      const removeItems = [];

      // æ”¶é›†å‹¾é¸çš„æ–°å¢å“é …
      document.querySelectorAll('.diff-checkbox[data-type="added"]:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        const d = menuDiff.added[idx];
        applyItems.push({
          item: d.item,
          category: d.category
        });
      });

      // æ”¶é›†å‹¾é¸çš„ä¿®æ”¹å“é …
      document.querySelectorAll('.diff-checkbox[data-type="modified"]:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        const d = menuDiff.modified[idx];
        applyItems.push({
          item: d.new_item,
          category: d.category
        });
      });

      // æ”¶é›†å‹¾é¸çš„åˆªé™¤å“é …
      document.querySelectorAll('.diff-checkbox[data-type="removed"]:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        const d = menuDiff.removed[idx];
        removeItems.push(d.item.id);
      });

      // å‘¼å« API å·®ç•°å„²å­˜
      try {
        const res = await fetch('/api/save-menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: targetStoreId,
            diff_mode: true,
            apply_items: applyItems,
            remove_items: removeItems
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'å„²å­˜å¤±æ•—');
        }

        closeMenuUpload();
        loadAllStores();

        const addedCount = applyItems.length;
        const removedCount = removeItems.length;
        showNotification(`èœå–®å·²æ›´æ–°ï¼æ–°å¢/ä¿®æ”¹ ${addedCount} é …ï¼Œåˆªé™¤ ${removedCount} é …`);

      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
      }
    }
  </script>
</body>
</html>
