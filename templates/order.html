<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>jiaba - è¨‚é¤</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <a href="/" class="back-link">â† è¿”å›çœ‹æ¿</a>

  <div class="container">
    <div class="chat-container">
      <div class="chat-header">
        <h1>ğŸ± jiaba è¨‚é¤åŠ©æ‰‹</h1>
      </div>

      <!-- åç¨±è¼¸å…¥ -->
      <div class="name-input-container" id="name-input-section">
        <h2>è«‹è¼¸å…¥ä½ çš„åå­—</h2>
        <input type="text" id="username-input" placeholder="ä½ çš„åå­—" autofocus>
        <button class="btn btn-primary" onclick="startChat()">é–‹å§‹è¨‚é¤</button>
      </div>

      <!-- å°è©±å€åŸŸ -->
      <div class="chat-messages" id="chat-messages" style="display: none;">
        <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
      </div>

      <div class="chat-input" id="chat-input" style="display: none;">
        <input type="text" id="message-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">ç™¼é€</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let username = '';

    // æª¢æŸ¥ localStorage æ˜¯å¦æœ‰å„²å­˜çš„åå­—
    const savedName = localStorage.getItem('jiaba_username');
    if (savedName) {
      document.getElementById('username-input').value = savedName;
    }

    // é–‹å§‹å°è©±
    function startChat() {
      const input = document.getElementById('username-input');
      username = input.value.trim();

      if (!username) {
        alert('è«‹è¼¸å…¥åå­—');
        return;
      }

      // å„²å­˜åå­—åˆ° localStorage
      localStorage.setItem('jiaba_username', username);

      // éš±è—åç¨±è¼¸å…¥ï¼Œé¡¯ç¤ºå°è©±å€åŸŸ
      document.getElementById('name-input-section').style.display = 'none';
      document.getElementById('chat-messages').style.display = 'block';
      document.getElementById('chat-input').style.display = 'flex';

      // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
      addMessage('assistant', `å—¨ ${username}ï¼æˆ‘æ˜¯ jiabaï¼Œä»Šå¤©æƒ³åƒä»€éº¼å‘¢ï¼Ÿ\n\nä½ å¯ä»¥å•æˆ‘ï¼š\nâ€¢ ä»Šå¤©æœ‰ä»€éº¼å¯ä»¥åƒï¼Ÿ\nâ€¢ çœ‹çœ‹èœå–®\nâ€¢ æˆ‘è¦é»é›è…¿ä¾¿ç•¶\nâ€¢ æŸ¥è©¢æˆ‘çš„è¨‚å–®`);

      document.getElementById('message-input').focus();
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', message);
      input.value = '';

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addMessage('assistant', 'æ€è€ƒä¸­...');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            message: message,
            is_manager: false
          })
        });

        const data = await res.json();

        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(loadingId).remove();

        // é¡¯ç¤º AI å›æ‡‰
        addMessage('assistant', data.message || 'æŠ±æ­‰ï¼Œæˆ‘æ²’æœ‰ç†è§£ä½ çš„æ„æ€ã€‚');

        // å¦‚æœæœ‰åŸ·è¡Œå‹•ä½œï¼Œé¡¯ç¤ºçµæœ
        if (data.action_result) {
          if (data.action_result.success) {
            if (data.action_result.event === 'order_created') {
              addMessage('assistant', 'âœ… è¨‚å–®å·²å»ºç«‹ï¼ä½ å¯ä»¥åœ¨çœ‹æ¿ä¸Šçœ‹åˆ°ä½ çš„è¨‚å–®ã€‚');
            } else if (data.action_result.event === 'order_cancelled') {
              addMessage('assistant', 'âœ… è¨‚å–®å·²å–æ¶ˆã€‚');
            }
          } else if (data.action_result.error) {
            addMessage('assistant', `âŒ æ“ä½œå¤±æ•—ï¼š${data.action_result.error}`);
          }
        }

      } catch (err) {
        document.getElementById(loadingId).remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        console.error(err);
      }
    }

    // æ·»åŠ è¨Šæ¯åˆ°å°è©±å€åŸŸ
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const id = 'msg-' + Date.now();

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;
      msgEl.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // ç›£è½è¨‚å–®äº‹ä»¶
    socket.on('order_created', (data) => {
      if (data.username !== username) {
        showNotification(`${data.username} ä¹Ÿè¨‚äº†ä¾¿ç•¶ï¼`);
      }
    });

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // æŒ‰ Enter é–‹å§‹
    document.getElementById('username-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') startChat();
    });
  </script>
</body>
</html>
