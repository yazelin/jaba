<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - è¨‚é¤</title>
  <link rel="icon" type="image/png" href="/static/images/jaba.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container order-container">
    <div class="order-three-columns">
      <!-- å·¦å´ï¼šåº—å®¶èˆ‡èœå–® -->
      <div class="order-left-panel" id="left-panel" style="display: none;">
        <!-- ä»Šæ—¥åº—å®¶è³‡è¨Š -->
        <div class="panel-card store-info-panel">
          <div class="panel-header">
            <span>ğŸª</span>
            <span>ä»Šæ—¥åº—å®¶</span>
          </div>
          <div class="panel-content" id="store-info-content">
            <div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>
          </div>
        </div>

        <!-- èœå–®é¢æ¿ -->
        <div class="panel-card menu-panel">
          <div class="panel-header">
            <span>ğŸ“‹</span>
            <span>èœå–®</span>
          </div>
          <div class="panel-content" id="menu-content">
            <div class="no-store-msg">è«‹ç­‰å¾…ç®¡ç†å“¡è¨­å®šä»Šæ—¥åº—å®¶</div>
          </div>
        </div>
      </div>

      <!-- ä¸­é–“ï¼šå°è©±å€ -->
      <div class="chat-container">
        <div class="chat-header">
          <a href="/" class="back-link">â† è¿”å›</a>
          <h1><img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="logo-icon"> å‘·çˆ¸è¨‚é¤åŠ©æ‰‹</h1>
          <div class="header-spacer"></div>
        </div>

        <!-- åç¨±è¼¸å…¥ -->
        <div class="name-input-container" id="name-input-section">
          <h2>è«‹è¼¸å…¥ä½ çš„åå­—</h2>
          <input type="text" id="username-input" placeholder="ä½ çš„åå­—" autofocus>
          <button class="btn btn-primary" onclick="startChat()">é–‹å§‹è¨‚é¤</button>
        </div>

        <!-- å°è©±å€åŸŸ -->
        <div class="chat-messages" id="chat-messages" style="display: none;">
          <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
        </div>

        <div class="chat-input" id="chat-input" style="display: none;">
          <input type="text" id="message-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleKeyPress(event)">
          <button onclick="sendMessage()">ç™¼é€</button>
        </div>
      </div>

      <!-- å³å´ï¼šè¨‚å–®é¢æ¿ -->
      <div class="order-right-panel" id="right-panel" style="display: none;">
        <!-- æˆ‘çš„è¨‚å–®é¢æ¿ -->
        <div class="panel-card orders-panel">
          <div class="panel-header">
            <span>ğŸ“¦</span>
            <span>æˆ‘çš„è¨‚å–®</span>
          </div>
          <div class="panel-content" id="my-orders-content">
            <div class="orders-empty">ä½ é‚„æ²’æœ‰è¨‚é¤</div>
          </div>
        </div>

        <!-- å¤§å®¶çš„è¨‚å–®é¢æ¿ -->
        <div class="panel-card orders-panel">
          <div class="panel-header">
            <span>ğŸ“‹</span>
            <span>å¤§å®¶çš„è¨‚å–®</span>
          </div>
          <div class="panel-content" id="all-orders-content">
            <div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¾é£Ÿè©•è«–å€ -->
  <div class="team-chat" id="team-chat">
    <div class="team-chat-header" onclick="toggleTeamChat()">
      <span class="team-chat-title">
        <span>ğŸ’¬ ç¾é£Ÿè©•è«–å€</span>
        <span class="unread-badge" id="unread-badge" style="display: none;">0</span>
      </span>
      <button class="team-chat-toggle" id="chat-toggle-btn">â–¼</button>
    </div>
    <div class="team-chat-messages" id="team-chat-messages">
      <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
    </div>
    <div class="team-chat-input">
      <input type="text" id="team-chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleTeamChatKeyPress(event)">
      <button onclick="sendTeamChatMessage()">ç™¼é€</button>
    </div>
  </div>

  <script>
    const socket = io();
    let username = '';
    let todayInfo = null;
    let todayMenu = null;
    let todaySummary = null;

    // === ç€è¦½å™¨é€šçŸ¥ ===
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendBrowserNotification(title, body, tag = null) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: '/static/images/jaba.png',
          tag: tag || `jaba-${Date.now()}`,
          requireInteraction: false
        };

        const notification = new Notification(title, options);
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    // é é¢è¼‰å…¥æ™‚è«‹æ±‚é€šçŸ¥æ¬Šé™
    requestNotificationPermission();

    // æª¢æŸ¥ localStorage æ˜¯å¦æœ‰å„²å­˜çš„åå­—
    const savedName = localStorage.getItem('jaba_username');
    if (savedName) {
      document.getElementById('username-input').value = savedName;
    }

    // === ä»Šæ—¥è³‡è¨Šèˆ‡èœå–® ===
    let todayStores = [];  // å¤šåº—å®¶è³‡æ–™

    async function loadTodayInfo(forUsername = null) {
      try {
        const url = forUsername ? `/api/today?username=${encodeURIComponent(forUsername)}` : '/api/today';
        const res = await fetch(url);
        const data = await res.json();
        todayInfo = data.today;
        todaySummary = data.summary;
        todayStores = data.stores || [];

        // æ›´æ–°åº—å®¶è³‡è¨Šé¢æ¿
        updateStoreInfoPanel(data.stores);

        // æ›´æ–°èœå–®é¢æ¿ï¼ˆæ”¯æ´å¤šåº—å®¶ï¼‰
        updateMenuPanel(data.stores);

        // æ›´æ–°è¨‚å–®é¢æ¿
        updateOrdersPanel(data.summary);

        return data.preferred_name;
      } catch (err) {
        console.error('è¼‰å…¥ä»Šæ—¥è³‡è¨Šå¤±æ•—:', err);
        return null;
      }
    }

    function updateStoreInfoPanel(stores) {
      const content = document.getElementById('store-info-content');

      if (stores && stores.length > 0) {
        let html = '';
        stores.forEach((storeData, index) => {
          const store = storeData.store;
          if (store) {
            if (index > 0) html += '<div class="store-divider"></div>';
            html += `<div class="store-title">${store.name}</div>`;
            if (store.phone) {
              html += `<div class="store-phone">é›»è©±ï¼š${store.phone}</div>`;
            }
            if (store.note) {
              html += `<div class="store-note">${store.note}</div>`;
            }
          }
        });
        content.innerHTML = html || '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
      } else {
        content.innerHTML = '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
      }
    }

    function updateMenuPanel(stores) {
      const content = document.getElementById('menu-content');

      // æ”¯æ´å¤šåº—å®¶
      if (stores && stores.length > 0) {
        let html = '';
        stores.forEach((storeData, storeIndex) => {
          const store = storeData.store;
          const menu = storeData.menu;

          if (store && menu && menu.categories) {
            // å¤šåº—å®¶æ™‚é¡¯ç¤ºåº—åæ¨™é¡Œ
            if (stores.length > 1) {
              if (storeIndex > 0) html += '<div class="menu-store-divider"></div>';
              html += `<div class="menu-store-title">ğŸª ${store.name}</div>`;
            }

            menu.categories.forEach(category => {
              html += `<div class="menu-category">`;
              html += `<div class="menu-category-title">${category.name}</div>`;
              category.items.forEach(item => {
                const unavailableClass = item.available === false ? ' unavailable' : '';
                const escapedName = item.name.replace(/'/g, "\\'");

                if (item.variants && item.variants.length > 0) {
                  // æœ‰å°ºå¯¸è®Šé«”ï¼šé¡¯ç¤ºå“é …åç¨±å’Œå„å°ºå¯¸é¸é …
                  html += `
                    <div class="menu-item-with-variants${unavailableClass}" title="${item.description || ''}">
                      <span class="menu-item-name">${item.name}</span>
                      <div class="menu-item-variants">
                        ${item.variants.map(v => {
                          const escapedSize = v.name.replace(/'/g, "\\'");
                          return `<span class="menu-variant-btn" onclick="quickOrder('${escapedName} ${escapedSize}', ${v.price}, '${store.id}')">${v.name} $${v.price}</span>`;
                        }).join('')}
                      </div>
                    </div>
                  `;
                } else {
                  // ç„¡å°ºå¯¸è®Šé«”ï¼šåŸæœ¬çš„é¡¯ç¤ºæ–¹å¼
                  html += `
                    <div class="menu-item${unavailableClass}" onclick="quickOrder('${escapedName}', ${item.price}, '${store.id}')" title="${item.description || ''}">
                      <span class="menu-item-name">${item.name}</span>
                      <span class="menu-item-price">$${item.price}</span>
                    </div>
                  `;
                }
              });
              html += `</div>`;
            });
          }
        });

        content.innerHTML = html || '<div class="no-store-msg">æš«ç„¡èœå–®è³‡æ–™</div>';
        return;
      }

      content.innerHTML = '<div class="no-store-msg">è«‹ç­‰å¾…ç®¡ç†å“¡è¨­å®šä»Šæ—¥åº—å®¶</div>';
    }

    function updateOrdersPanel(summary) {
      // æ›´æ–°ã€Œæˆ‘çš„è¨‚å–®ã€é¢æ¿
      updateMyOrdersPanel(summary);
      // æ›´æ–°ã€Œå¤§å®¶çš„è¨‚å–®ã€é¢æ¿
      updateAllOrdersPanel(summary);
    }

    function updateMyOrdersPanel(summary) {
      const content = document.getElementById('my-orders-content');
      if (!summary || !summary.orders) {
        content.innerHTML = '<div class="orders-empty">ä½ é‚„æ²’æœ‰è¨‚é¤</div>';
        return;
      }

      // éæ¿¾åªé¡¯ç¤ºç•¶å‰ä½¿ç”¨è€…çš„è¨‚å–®
      const myOrders = summary.orders.filter(order => order.username === username);
      if (myOrders.length === 0) {
        content.innerHTML = '<div class="orders-empty">ä½ é‚„æ²’æœ‰è¨‚é¤</div>';
        return;
      }

      // å¤šåº—å®¶æ™‚æŒ‰åº—å®¶åˆ†çµ„
      const hasMultipleStores = todayStores && todayStores.length > 1;
      let html = '';
      let myTotal = 0;
      let myTotalCalories = 0;

      if (hasMultipleStores) {
        // æŒ‰åº—å®¶åˆ†çµ„è¨‚å–®
        const ordersByStore = {};
        myOrders.forEach(order => {
          const storeId = order.store_id || 'unknown';
          if (!ordersByStore[storeId]) {
            ordersByStore[storeId] = [];
          }
          ordersByStore[storeId].push(order);
          myTotal += order.total;
          myTotalCalories += order.total_calories || 0;
        });

        // ä¾åº—å®¶é¡¯ç¤º
        Object.keys(ordersByStore).forEach((storeId, index) => {
          const orders = ordersByStore[storeId];
          const storeName = orders[0]?.store_name || 'æœªçŸ¥åº—å®¶';

          if (index > 0) html += '<div class="orders-store-divider"></div>';
          html += `<div class="orders-store-title">ğŸª ${storeName}</div>`;

          orders.forEach(order => {
            order.items.forEach(item => {
              const itemCalories = item.calories ? ` (${item.calories}å¤§å¡)` : '';
              const itemQty = item.quantity > 1 ? ` x${item.quantity}` : '';
              const itemNote = item.note ? `<div class="live-order-note">${item.note}</div>` : '';
              html += `
                <div class="live-order-item">
                  <div>
                    <div class="live-order-items">${item.name}${itemQty}${itemCalories}</div>
                    ${itemNote}
                  </div>
                  <div class="live-order-total">$${item.price * item.quantity}</div>
                </div>
              `;
            });
          });
        });
      } else {
        // å–®åº—å®¶ï¼šç›´æ¥åˆ—å‡º
        myOrders.forEach(order => {
          myTotal += order.total;
          myTotalCalories += order.total_calories || 0;
          order.items.forEach(item => {
            const itemCalories = item.calories ? ` (${item.calories}å¤§å¡)` : '';
            const itemQty = item.quantity > 1 ? ` x${item.quantity}` : '';
            const itemNote = item.note ? `<div class="live-order-note">${item.note}</div>` : '';
            html += `
              <div class="live-order-item">
                <div>
                  <div class="live-order-items">${item.name}${itemQty}${itemCalories}</div>
                  ${itemNote}
                </div>
                <div class="live-order-total">$${item.price * item.quantity}</div>
              </div>
            `;
          });
        });
      }

      // åŠ ä¸Šç¸½è¨ˆï¼ˆå«å¡è·¯é‡Œï¼‰
      const caloriesText = myTotalCalories > 0 ? ` / ${myTotalCalories}å¤§å¡` : '';
      html += `
        <div class="orders-summary">
          <span class="orders-summary-label">å…± ${myOrders.length} ç­†${caloriesText}</span>
          <span class="orders-summary-amount">$${myTotal}</span>
        </div>
      `;
      content.innerHTML = html;
    }

    function updateAllOrdersPanel(summary) {
      const content = document.getElementById('all-orders-content');
      if (!summary || !summary.orders || summary.orders.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>';
        return;
      }

      // å¤šåº—å®¶æ™‚æŒ‰åº—å®¶åˆ†çµ„
      const hasMultipleStores = todayStores && todayStores.length > 1;
      let html = '';

      if (hasMultipleStores) {
        // æŒ‰åº—å®¶åˆ†çµ„è¨‚å–®
        const ordersByStore = {};
        summary.orders.forEach(order => {
          const storeId = order.store_id || 'unknown';
          if (!ordersByStore[storeId]) {
            ordersByStore[storeId] = [];
          }
          ordersByStore[storeId].push(order);
        });

        // ä¾åº—å®¶é¡¯ç¤º
        Object.keys(ordersByStore).forEach((storeId, index) => {
          const orders = ordersByStore[storeId];
          const storeName = orders[0]?.store_name || 'æœªçŸ¥åº—å®¶';

          if (index > 0) html += '<div class="orders-store-divider"></div>';
          html += `<div class="orders-store-title">ğŸª ${storeName}</div>`;

          orders.forEach(order => {
            const itemsText = order.items.map(i => {
              let text = i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name;
              if (i.note) text += ` (${i.note})`;
              return text;
            }).join('ã€');
            html += `
              <div class="live-order-item">
                <div>
                  <div class="live-order-user">${order.username}</div>
                  <div class="live-order-items">${itemsText}</div>
                </div>
                <div class="live-order-total">$${order.total}</div>
              </div>
            `;
          });
        });
      } else {
        // å–®åº—å®¶ï¼šç›´æ¥åˆ—å‡º
        summary.orders.forEach(order => {
          const itemsText = order.items.map(i => {
            let text = i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name;
            if (i.note) text += ` (${i.note})`;
            return text;
          }).join('ã€');
          html += `
            <div class="live-order-item">
              <div>
                <div class="live-order-user">${order.username}</div>
                <div class="live-order-items">${itemsText}</div>
              </div>
              <div class="live-order-total">$${order.total}</div>
            </div>
          `;
        });
      }

      // åŠ ä¸Šç¸½è¨ˆ
      html += `
        <div class="orders-summary">
          <span class="orders-summary-label">ç¸½è¨ˆ ${summary.orders.length} ä»½</span>
          <span class="orders-summary-amount">$${summary.grand_total}</span>
        </div>
      `;
      content.innerHTML = html;
    }

    // å¿«é€Ÿé»é¤ï¼šé»æ“Šèœå–®é …ç›®
    function quickOrder(itemName, price, storeId) {
      if (!username) {
        alert('è«‹å…ˆè¼¸å…¥åå­—');
        return;
      }
      const input = document.getElementById('message-input');
      // å¦‚æœæœ‰å¤šåº—å®¶ï¼ŒåŠ å…¥åº—å®¶è³‡è¨Š
      if (todayStores.length > 1 && storeId) {
        const store = todayStores.find(s => s.store && s.store.id === storeId);
        if (store) {
          input.value = `æˆ‘è¦åœ¨${store.store.name}é» ${itemName}`;
        } else {
          input.value = `æˆ‘è¦é» ${itemName}`;
        }
      } else {
        input.value = `æˆ‘è¦é» ${itemName}`;
      }
      input.focus();
    }

    // é–‹å§‹å°è©±
    async function startChat() {
      const input = document.getElementById('username-input');
      username = input.value.trim();

      if (!username) {
        alert('è«‹è¼¸å…¥åå­—');
        return;
      }

      // å„²å­˜åå­—åˆ° localStorage
      localStorage.setItem('jaba_username', username);

      // é‡ç½® sessionï¼Œç¢ºä¿æ¯æ¬¡é€²å…¥éƒ½æ˜¯æ–°å°è©±
      await fetch('/api/session/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: username, is_manager: false })
      });

      // éš±è—åç¨±è¼¸å…¥ï¼Œé¡¯ç¤ºå°è©±å€åŸŸå’Œå·¦å³é¢æ¿
      document.getElementById('name-input-section').style.display = 'none';
      document.getElementById('chat-messages').style.display = 'block';
      document.getElementById('chat-input').style.display = 'flex';
      document.getElementById('left-panel').style.display = 'flex';
      document.getElementById('right-panel').style.display = 'flex';

      // è¼‰å…¥ä»Šæ—¥è³‡è¨Šä¸¦å–å¾—åå¥½ç¨±å‘¼
      const preferredName = await loadTodayInfo(username);
      const displayName = preferredName || 'æˆ‘å€‘';

      // æ ¹æ“šä»Šæ—¥åº—å®¶é¡¯ç¤ºä¸åŒçš„æ­¡è¿è¨Šæ¯
      let welcomeMsg = `å“‡ä¿‚å‘·çˆ¸ï¼Œ${displayName}ä»Šå¤©æƒ³åƒä»€éº¼å‘¢ï¼Ÿ\n\n`;
      // ä¾åº—å®¶æ•¸é‡é¡¯ç¤ºä¸åŒè¨Šæ¯
      if (todayStores && todayStores.length > 1) {
        const storeNames = todayStores.map(s => s.store?.name).filter(Boolean).join('ã€');
        welcomeMsg += `ä»Šå¤©æœ‰ ${todayStores.length} å®¶åº—å¯ä»¥é¸ï¼š${storeNames}ï½\n`;
        welcomeMsg += `ç›´æ¥é»å·¦é‚Šèœå–®çš„å“é …ï¼Œæˆ–è·Ÿæˆ‘èªªæƒ³åƒä»€éº¼ï¼\n\n`;
        welcomeMsg += `ä¸çŸ¥é“åƒä»€éº¼ï¼Ÿå•æˆ‘ã€Œä»Šå¤©åƒä»€éº¼å¥½ï¼Ÿã€`;
      } else if (todayStores && todayStores.length === 1) {
        const storeName = todayStores[0].store?.name || '';
        welcomeMsg += `ä»Šå¤©çš„åº—å®¶æ˜¯ã€Œ${storeName}ã€ï½\n`;
        welcomeMsg += `ç›´æ¥é»å·¦é‚Šèœå–®çš„å“é …ï¼Œæˆ–è·Ÿæˆ‘èªªæƒ³åƒä»€éº¼ï¼\n\n`;
        welcomeMsg += `ä¸çŸ¥é“åƒä»€éº¼ï¼Ÿå•æˆ‘ã€Œä»Šå¤©åƒä»€éº¼å¥½ï¼Ÿã€`;
      } else {
        welcomeMsg += `å•æˆ‘ï¼š\nâ€¢ ä»Šå¤©æœ‰ä»€éº¼å¯ä»¥åƒï¼Ÿ\nâ€¢ çœ‹çœ‹èœå–®\nâ€¢ æˆ‘è¦é»é›è…¿ä¾¿ç•¶\n\næœ‰ä»€éº¼åå¥½æˆ–éœ€è¦å»ºè­°å—ï¼Ÿ`;
      }
      addMessage('assistant', welcomeMsg);

      document.getElementById('message-input').focus();
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', message);
      input.value = '';

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addMessage('assistant', 'æ€è€ƒä¸­...');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            message: message,
            is_manager: false
          })
        });

        const data = await res.json();

        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(loadingId).remove();

        // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤ºä¸åŒè¨Šæ¯
        if (data.error) {
          if (data.error === 'timeout') {
            addMessage('assistant', 'æŠ±æ­‰ï¼Œå›æ‡‰è¶…æ™‚äº†ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚');
          } else {
            // parse_errorã€no_response ç­‰ï¼šé¡¯ç¤º AI çš„å¯¦éš›å›æ‡‰
            addMessage('assistant', data.message || 'æŠ±æ­‰ï¼Œæˆ‘æ²’æœ‰ç†è§£ä½ çš„æ„æ€ã€‚');
          }
        } else {
          // æ­£å¸¸é¡¯ç¤º AI å›æ‡‰
          addMessage('assistant', data.message || 'æŠ±æ­‰ï¼Œæˆ‘æ²’æœ‰ç†è§£ä½ çš„æ„æ€ã€‚');
        }

        // å¦‚æœæœ‰åŸ·è¡Œå‹•ä½œï¼Œé¡¯ç¤ºçµæœ
        if (data.action_results && data.action_results.length > 0) {
          for (const result of data.action_results) {
            if (result.success) {
              if (result.event === 'order_created') {
                addMessage('assistant', 'âœ… è¨‚å–®å·²å»ºç«‹ï¼ä½ å¯ä»¥åœ¨çœ‹æ¿ä¸Šçœ‹åˆ°ä½ çš„è¨‚å–®ã€‚');
                // æ›´æ–°è¨‚å–®é¢æ¿
                if (result.summary) updateOrdersPanel(result.summary);
              } else if (result.event === 'order_cancelled') {
                addMessage('assistant', 'âœ… è¨‚å–®å·²å–æ¶ˆã€‚');
                // æ›´æ–°è¨‚å–®é¢æ¿
                if (result.summary) updateOrdersPanel(result.summary);
              } else if (result.event === 'order_updated') {
                addMessage('assistant', 'âœ… è¨‚å–®å·²æ›´æ–°ã€‚');
                // æ›´æ–°è¨‚å–®é¢æ¿
                if (result.summary) updateOrdersPanel(result.summary);
              }
            } else if (result.error) {
              addMessage('assistant', `âŒ æ“ä½œå¤±æ•—ï¼š${result.error}`);
            }
          }
        }

      } catch (err) {
        document.getElementById(loadingId).remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        console.error(err);
      }
    }

    // è¨Šæ¯ ID è¨ˆæ•¸å™¨
    let messageIdCounter = 0;

    // æ·»åŠ è¨Šæ¯åˆ°å°è©±å€åŸŸ
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const id = 'msg-' + Date.now() + '-' + (messageIdCounter++);

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;

      if (role === 'assistant') {
        msgEl.innerHTML = `
          <div class="message-avatar">
            <img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="avatar-icon">
          </div>
          <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
        `;
      } else {
        msgEl.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;
      }

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // ç›£è½è¨‚å–®äº‹ä»¶
    socket.on('order_created', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      }
      if (data.username !== username) {
        showNotification(`${data.username} ä¹Ÿè¨‚äº†ä¾¿ç•¶ï¼`);
        sendBrowserNotification('æ–°è¨‚å–®', `${data.username} è¨‚äº†ä¾¿ç•¶ï¼`, 'order-created');
      }
    });

    socket.on('order_cancelled', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      } else {
        // å¦‚æœæ²’å¸¶ summaryï¼Œé‡æ–°è¼‰å…¥
        loadTodayInfo();
      }
      if (data.username !== username) {
        showNotification(`${data.username} å–æ¶ˆäº†è¨‚å–®`);
        sendBrowserNotification('è¨‚å–®å–æ¶ˆ', `${data.username} å–æ¶ˆäº†è¨‚å–®`, 'order-cancelled');
      }
    });

    socket.on('order_updated', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿ï¼ˆå“é …ç§»é™¤æˆ–ä¿®æ”¹æ™‚ï¼‰
      if (data.summary) {
        updateOrdersPanel(data.summary);
      } else {
        // å¦‚æœæ²’å¸¶ summaryï¼Œé‡æ–°è¼‰å…¥
        loadTodayInfo();
      }
    });

    socket.on('orders_cleared', (data) => {
      // æ¸…ç©ºè¨‚å–®é¢æ¿
      updateOrdersPanel(null);
      showNotification('ç®¡ç†å“¡å·²æ¸…é™¤æ‰€æœ‰è¨‚å–®');
      sendBrowserNotification('è¨‚å–®æ¸…é™¤', 'ç®¡ç†å“¡å·²æ¸…é™¤æ‰€æœ‰è¨‚å–®', 'orders-cleared');
    });

    socket.on('store_changed', (data) => {
      const storeName = data.store_name || 'æ–°åº—å®¶';
      // é‡æ–°è¼‰å…¥ä»Šæ—¥è³‡è¨Šï¼ˆåŒ…æ‹¬æ–°èœå–®ï¼‰
      loadTodayInfo();
      showNotification(`ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`);
      sendBrowserNotification('åº—å®¶æ›´æ–°', `ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`, 'store-changed');
    });

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // æŒ‰ Enter é–‹å§‹
    document.getElementById('username-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') startChat();
    });

    // === ç¾é£Ÿè©•è«–å€ ===
    let teamChatOpen = true;  // é è¨­å±•é–‹
    let unreadCount = 0;

    // åˆ‡æ›èŠå¤©å®¤å±•é–‹/æ”¶èµ·
    function toggleTeamChat() {
      const chatEl = document.getElementById('team-chat');
      teamChatOpen = !teamChatOpen;

      if (teamChatOpen) {
        chatEl.classList.remove('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–¼';
        // æ¸…é™¤æœªè®€æ•¸
        unreadCount = 0;
        updateUnreadBadge();
        // æ²å‹•åˆ°æœ€æ–°è¨Šæ¯
        const messagesEl = document.getElementById('team-chat-messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        chatEl.classList.add('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–²';
      }
    }

    // æ›´æ–°æœªè®€å¾½ç« 
    function updateUnreadBadge() {
      const badge = document.getElementById('unread-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // è™•ç† Enter éµç™¼é€åœ˜éšŠè¨Šæ¯
    function handleTeamChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendTeamChatMessage();
      }
    }

    // ç™¼é€åœ˜éšŠèŠå¤©è¨Šæ¯
    async function sendTeamChatMessage() {
      const input = document.getElementById('team-chat-input');
      const content = input.value.trim();

      if (!content || !username) return;

      input.value = '';

      try {
        await fetch('/api/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, content })
        });
      } catch (err) {
        console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', err);
      }
    }

    // æ·»åŠ åœ˜éšŠèŠå¤©è¨Šæ¯åˆ°ç•«é¢
    function addTeamChatMessage(msg) {
      const messagesEl = document.getElementById('team-chat-messages');
      const isOwn = msg.username === username;

      const msgEl = document.createElement('div');
      msgEl.className = `team-chat-message ${isOwn ? 'own' : ''}`;

      const time = new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
        hour: '2-digit',
        minute: '2-digit'
      });

      msgEl.innerHTML = `
        <div class="team-chat-message-header">
          <span class="team-chat-message-user">${msg.username}</span>
          <span class="team-chat-message-time">${time}</span>
        </div>
        <div class="team-chat-message-content">${msg.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
      `;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // è¼‰å…¥æ­·å²èŠå¤©è¨Šæ¯
    async function loadChatHistory() {
      try {
        const res = await fetch('/api/chat/messages');
        const data = await res.json();

        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => addTeamChatMessage(msg));
        }
      } catch (err) {
        console.error('è¼‰å…¥èŠå¤©è¨˜éŒ„å¤±æ•—:', err);
      }
    }

    // ç›£è½åœ˜éšŠèŠå¤©è¨Šæ¯
    socket.on('chat_message', (msg) => {
      addTeamChatMessage(msg);

      // å¦‚æœä¸æ˜¯è‡ªå·±çš„è¨Šæ¯
      if (msg.username !== username) {
        // èŠå¤©å®¤æ”¶èµ·æ™‚å¢åŠ æœªè®€æ•¸
        if (!teamChatOpen) {
          unreadCount++;
          updateUnreadBadge();
        }
        // ç™¼é€ç€è¦½å™¨é€šçŸ¥
        sendBrowserNotification(msg.username, msg.content, `chat-${msg.id}`);
      }
    });

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥èŠå¤©è¨˜éŒ„
    loadChatHistory();
  </script>
</body>
</html>
