<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘·çˆ¸ - è¨‚é¤</title>
  <link rel="icon" type="image/png" href="/static/images/jaba.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <a href="/" class="back-link">â† è¿”å›çœ‹æ¿</a>

  <div class="container">
    <div class="order-page-layout">
      <!-- å·¦å´ï¼šå°è©±å€ -->
      <div class="chat-container">
        <div class="chat-header">
          <h1><img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="logo-icon"> å‘·çˆ¸è¨‚é¤åŠ©æ‰‹</h1>
        </div>

        <!-- åç¨±è¼¸å…¥ -->
        <div class="name-input-container" id="name-input-section">
          <h2>è«‹è¼¸å…¥ä½ çš„åå­—</h2>
          <input type="text" id="username-input" placeholder="ä½ çš„åå­—" autofocus>
          <button class="btn btn-primary" onclick="startChat()">é–‹å§‹è¨‚é¤</button>
        </div>

        <!-- å°è©±å€åŸŸ -->
        <div class="chat-messages" id="chat-messages" style="display: none;">
          <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
        </div>

        <div class="chat-input" id="chat-input" style="display: none;">
          <input type="text" id="message-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleKeyPress(event)">
          <button onclick="sendMessage()">ç™¼é€</button>
        </div>
      </div>

      <!-- å³å´ï¼šå´é‚Šé¢æ¿ -->
      <div class="side-panel" id="side-panel" style="display: none;">
        <!-- ä»Šæ—¥åº—å®¶è³‡è¨Š -->
        <div class="panel-card store-info-panel">
          <div class="panel-header">
            <span>ğŸª</span>
            <span>ä»Šæ—¥åº—å®¶</span>
          </div>
          <div class="panel-content" id="store-info-content">
            <div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>
          </div>
        </div>

        <!-- èœå–®é¢æ¿ -->
        <div class="panel-card menu-panel">
          <div class="panel-header">
            <span>ğŸ“‹</span>
            <span>èœå–®</span>
          </div>
          <div class="panel-content" id="menu-content">
            <div class="no-store-msg">è«‹ç­‰å¾…ç®¡ç†å“¡è¨­å®šä»Šæ—¥åº—å®¶</div>
          </div>
        </div>

        <!-- å³æ™‚è¨‚å–®é¢æ¿ -->
        <div class="panel-card orders-panel">
          <div class="panel-header">
            <span>ğŸ“¦</span>
            <span>ä»Šæ—¥è¨‚å–®</span>
          </div>
          <div class="panel-content" id="orders-content">
            <div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åœ˜éšŠèŠå¤©å®¤ -->
  <div class="team-chat minimized" id="team-chat">
    <div class="team-chat-header" onclick="toggleTeamChat()">
      <span class="team-chat-title">
        <span>ğŸ’¬ åœ˜éšŠèŠå¤©å®¤</span>
        <span class="unread-badge" id="unread-badge" style="display: none;">0</span>
      </span>
      <button class="team-chat-toggle" id="chat-toggle-btn">â–²</button>
    </div>
    <div class="team-chat-messages" id="team-chat-messages">
      <!-- è¨Šæ¯æœƒå‹•æ…‹åŠ å…¥é€™è£¡ -->
    </div>
    <div class="team-chat-input">
      <input type="text" id="team-chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleTeamChatKeyPress(event)">
      <button onclick="sendTeamChatMessage()">ç™¼é€</button>
    </div>
  </div>

  <script>
    const socket = io();
    let username = '';
    let todayInfo = null;
    let todayMenu = null;
    let todaySummary = null;

    // === ç€è¦½å™¨é€šçŸ¥ ===
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendBrowserNotification(title, body, tag = null) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
          body: body,
          icon: '/static/images/jaba.png',
          tag: tag || `jaba-${Date.now()}`,
          requireInteraction: false
        };

        const notification = new Notification(title, options);
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    // é é¢è¼‰å…¥æ™‚è«‹æ±‚é€šçŸ¥æ¬Šé™
    requestNotificationPermission();

    // æª¢æŸ¥ localStorage æ˜¯å¦æœ‰å„²å­˜çš„åå­—
    const savedName = localStorage.getItem('jaba_username');
    if (savedName) {
      document.getElementById('username-input').value = savedName;
    }

    // === ä»Šæ—¥è³‡è¨Šèˆ‡èœå–® ===
    let todayStores = [];  // å¤šåº—å®¶è³‡æ–™

    async function loadTodayInfo() {
      try {
        const res = await fetch('/api/today');
        const data = await res.json();
        todayInfo = data.today;
        todaySummary = data.summary;
        todayStores = data.stores || [];

        // æ›´æ–°åº—å®¶è³‡è¨Šé¢æ¿ï¼ˆæ”¯æ´å¤šåº—å®¶ï¼‰
        updateStoreInfoPanel(data.today, data.stores);

        // æ›´æ–°èœå–®é¢æ¿ï¼ˆæ”¯æ´å¤šåº—å®¶ï¼‰
        updateMenuPanel(data.stores);

        // æ›´æ–°è¨‚å–®é¢æ¿
        updateOrdersPanel(data.summary);
      } catch (err) {
        console.error('è¼‰å…¥ä»Šæ—¥è³‡è¨Šå¤±æ•—:', err);
      }
    }

    function updateStoreInfoPanel(today, stores) {
      const content = document.getElementById('store-info-content');

      // æ”¯æ´å¤šåº—å®¶
      if (stores && stores.length > 0) {
        let html = '';
        stores.forEach((storeData, index) => {
          const store = storeData.store;
          if (store) {
            if (index > 0) html += '<div class="store-divider"></div>';
            html += `<div class="store-title">${store.name}</div>`;
            if (store.note) {
              html += `<div class="store-note">${store.note}</div>`;
            }
          }
        });
        content.innerHTML = html || '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
        return;
      }

      // å‘å¾Œç›¸å®¹ï¼šå–®åº—å®¶
      if (!today || !today.store_name) {
        content.innerHTML = '<div class="no-store-msg">å°šæœªè¨­å®šä»Šæ—¥åº—å®¶</div>';
        return;
      }
      content.innerHTML = `<div class="store-title">${today.store_name}</div>`;
    }

    function updateMenuPanel(stores) {
      const content = document.getElementById('menu-content');

      // æ”¯æ´å¤šåº—å®¶
      if (stores && stores.length > 0) {
        let html = '';
        stores.forEach((storeData, storeIndex) => {
          const store = storeData.store;
          const menu = storeData.menu;

          if (store && menu && menu.categories) {
            // å¤šåº—å®¶æ™‚é¡¯ç¤ºåº—åæ¨™é¡Œ
            if (stores.length > 1) {
              if (storeIndex > 0) html += '<div class="menu-store-divider"></div>';
              html += `<div class="menu-store-title">ğŸª ${store.name}</div>`;
            }

            menu.categories.forEach(category => {
              html += `<div class="menu-category">`;
              html += `<div class="menu-category-title">${category.name}</div>`;
              category.items.forEach(item => {
                const unavailableClass = item.available === false ? ' unavailable' : '';
                const escapedName = item.name.replace(/'/g, "\\'");
                html += `
                  <div class="menu-item${unavailableClass}" onclick="quickOrder('${escapedName}', ${item.price}, '${store.id}')" title="${item.description || ''}">
                    <span class="menu-item-name">${item.name}</span>
                    <span class="menu-item-price">$${item.price}</span>
                  </div>
                `;
              });
              html += `</div>`;
            });
          }
        });

        content.innerHTML = html || '<div class="no-store-msg">æš«ç„¡èœå–®è³‡æ–™</div>';
        return;
      }

      content.innerHTML = '<div class="no-store-msg">è«‹ç­‰å¾…ç®¡ç†å“¡è¨­å®šä»Šæ—¥åº—å®¶</div>';
    }

    function updateOrdersPanel(summary) {
      const content = document.getElementById('orders-content');
      if (!summary || !summary.orders || summary.orders.length === 0) {
        content.innerHTML = '<div class="orders-empty">ç›®å‰é‚„æ²’æœ‰è¨‚å–®</div>';
        return;
      }

      // å¤šåº—å®¶æ™‚æŒ‰åº—å®¶åˆ†çµ„
      const hasMultipleStores = todayStores && todayStores.length > 1;
      let html = '';

      if (hasMultipleStores) {
        // æŒ‰åº—å®¶åˆ†çµ„è¨‚å–®
        const ordersByStore = {};
        summary.orders.forEach(order => {
          const storeId = order.store_id || 'unknown';
          if (!ordersByStore[storeId]) {
            ordersByStore[storeId] = [];
          }
          ordersByStore[storeId].push(order);
        });

        // ä¾åº—å®¶é¡¯ç¤º
        Object.keys(ordersByStore).forEach((storeId, index) => {
          const orders = ordersByStore[storeId];
          const storeName = orders[0]?.store_name || 'æœªçŸ¥åº—å®¶';

          if (index > 0) html += '<div class="orders-store-divider"></div>';
          html += `<div class="orders-store-title">ğŸª ${storeName}</div>`;

          orders.forEach(order => {
            const itemsText = order.items.map(i => i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name).join('ã€');
            html += `
              <div class="live-order-item">
                <div>
                  <div class="live-order-user">${order.username}</div>
                  <div class="live-order-items">${itemsText}</div>
                </div>
                <div class="live-order-total">$${order.total}</div>
              </div>
            `;
          });
        });
      } else {
        // å–®åº—å®¶ï¼šç›´æ¥åˆ—å‡º
        summary.orders.forEach(order => {
          const itemsText = order.items.map(i => i.quantity > 1 ? `${i.name}x${i.quantity}` : i.name).join('ã€');
          html += `
            <div class="live-order-item">
              <div>
                <div class="live-order-user">${order.username}</div>
                <div class="live-order-items">${itemsText}</div>
              </div>
              <div class="live-order-total">$${order.total}</div>
            </div>
          `;
        });
      }

      // åŠ ä¸Šç¸½è¨ˆ
      html += `
        <div class="orders-summary">
          <span class="orders-summary-label">ç¸½è¨ˆ ${summary.orders.length} ä»½</span>
          <span class="orders-summary-amount">$${summary.grand_total}</span>
        </div>
      `;
      content.innerHTML = html;
    }

    // å¿«é€Ÿé»é¤ï¼šé»æ“Šèœå–®é …ç›®
    function quickOrder(itemName, price, storeId) {
      if (!username) {
        alert('è«‹å…ˆè¼¸å…¥åå­—');
        return;
      }
      const input = document.getElementById('message-input');
      // å¦‚æœæœ‰å¤šåº—å®¶ï¼ŒåŠ å…¥åº—å®¶è³‡è¨Š
      if (todayStores.length > 1 && storeId) {
        const store = todayStores.find(s => s.store && s.store.id === storeId);
        if (store) {
          input.value = `æˆ‘è¦åœ¨${store.store.name}é» ${itemName}`;
        } else {
          input.value = `æˆ‘è¦é» ${itemName}`;
        }
      } else {
        input.value = `æˆ‘è¦é» ${itemName}`;
      }
      input.focus();
    }

    // é–‹å§‹å°è©±
    function startChat() {
      const input = document.getElementById('username-input');
      username = input.value.trim();

      if (!username) {
        alert('è«‹è¼¸å…¥åå­—');
        return;
      }

      // å„²å­˜åå­—åˆ° localStorage
      localStorage.setItem('jaba_username', username);

      // éš±è—åç¨±è¼¸å…¥ï¼Œé¡¯ç¤ºå°è©±å€åŸŸå’Œå´é‚Šé¢æ¿
      document.getElementById('name-input-section').style.display = 'none';
      document.getElementById('chat-messages').style.display = 'block';
      document.getElementById('chat-input').style.display = 'flex';
      document.getElementById('side-panel').style.display = 'flex';

      // è¼‰å…¥ä»Šæ—¥è³‡è¨Š
      loadTodayInfo();

      // æ ¹æ“šä»Šæ—¥åº—å®¶é¡¯ç¤ºä¸åŒçš„æ­¡è¿è¨Šæ¯
      let welcomeMsg = `å—¨ ${username}ï¼æˆ‘æ˜¯å‘·çˆ¸ï¼Œä»Šå¤©æƒ³åƒä»€éº¼å‘¢ï¼Ÿ\n\n`;
      // æ”¯æ´å¤šåº—å®¶
      if (todayStores && todayStores.length > 1) {
        const storeNames = todayStores.map(s => s.store?.name).filter(Boolean).join('ã€');
        welcomeMsg += `ä»Šå¤©æœ‰ ${todayStores.length} å®¶åº—å¯ä»¥é¸ï¼š${storeNames}ã€‚\n`;
        welcomeMsg += `ä½ å¯ä»¥ç›´æ¥é»å³é‚Šèœå–®ä¸Šçš„å“é …ï¼Œæˆ–æ˜¯å‘Šè¨´æˆ‘ä½ æƒ³é»ä»€éº¼ï¼`;
      } else if (todayInfo && todayInfo.store_name) {
        welcomeMsg += `ä»Šå¤©çš„åº—å®¶æ˜¯ã€Œ${todayInfo.store_name}ã€ï¼Œ`;
        welcomeMsg += `ä½ å¯ä»¥ç›´æ¥é»å³é‚Šèœå–®ä¸Šçš„å“é …ï¼Œæˆ–æ˜¯å‘Šè¨´æˆ‘ä½ æƒ³é»ä»€éº¼ï¼`;
      } else {
        welcomeMsg += `ä½ å¯ä»¥å•æˆ‘ï¼š\nâ€¢ ä»Šå¤©æœ‰ä»€éº¼å¯ä»¥åƒï¼Ÿ\nâ€¢ çœ‹çœ‹èœå–®\nâ€¢ æˆ‘è¦é»é›è…¿ä¾¿ç•¶\nâ€¢ æŸ¥è©¢æˆ‘çš„è¨‚å–®`;
      }
      addMessage('assistant', welcomeMsg);

      document.getElementById('message-input').focus();
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message) return;

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', message);
      input.value = '';

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const loadingId = addMessage('assistant', 'æ€è€ƒä¸­...');

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            message: message,
            is_manager: false
          })
        });

        const data = await res.json();

        // ç§»é™¤è¼‰å…¥è¨Šæ¯
        document.getElementById(loadingId).remove();

        // é¡¯ç¤º AI å›æ‡‰
        addMessage('assistant', data.message || 'æŠ±æ­‰ï¼Œæˆ‘æ²’æœ‰ç†è§£ä½ çš„æ„æ€ã€‚');

        // å¦‚æœæœ‰åŸ·è¡Œå‹•ä½œï¼Œé¡¯ç¤ºçµæœ
        if (data.action_result) {
          if (data.action_result.success) {
            if (data.action_result.event === 'order_created') {
              addMessage('assistant', 'âœ… è¨‚å–®å·²å»ºç«‹ï¼ä½ å¯ä»¥åœ¨çœ‹æ¿ä¸Šçœ‹åˆ°ä½ çš„è¨‚å–®ã€‚');
            } else if (data.action_result.event === 'order_cancelled') {
              addMessage('assistant', 'âœ… è¨‚å–®å·²å–æ¶ˆã€‚');
            }
          } else if (data.action_result.error) {
            addMessage('assistant', `âŒ æ“ä½œå¤±æ•—ï¼š${data.action_result.error}`);
          }
        }

      } catch (err) {
        document.getElementById(loadingId).remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        console.error(err);
      }
    }

    // æ·»åŠ è¨Šæ¯åˆ°å°è©±å€åŸŸ
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const id = 'msg-' + Date.now();

      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = `message ${role}`;

      if (role === 'assistant') {
        msgEl.innerHTML = `
          <div class="message-avatar">
            <img src="/static/images/jaba.png" alt="å‘·çˆ¸" class="avatar-icon">
          </div>
          <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
        `;
      } else {
        msgEl.innerHTML = `<div class="message-content">${content.replace(/\n/g, '<br>')}</div>`;
      }

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      return id;
    }

    // ç›£è½è¨‚å–®äº‹ä»¶
    socket.on('order_created', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      }
      if (data.username !== username) {
        showNotification(`${data.username} ä¹Ÿè¨‚äº†ä¾¿ç•¶ï¼`);
        sendBrowserNotification('æ–°è¨‚å–®', `${data.username} è¨‚äº†ä¾¿ç•¶ï¼`, 'order-created');
      }
    });

    socket.on('order_cancelled', (data) => {
      // æ›´æ–°è¨‚å–®é¢æ¿
      if (data.summary) {
        updateOrdersPanel(data.summary);
      } else {
        // å¦‚æœæ²’å¸¶ summaryï¼Œé‡æ–°è¼‰å…¥
        loadTodayInfo();
      }
      if (data.username !== username) {
        showNotification(`${data.username} å–æ¶ˆäº†è¨‚å–®`);
        sendBrowserNotification('è¨‚å–®å–æ¶ˆ', `${data.username} å–æ¶ˆäº†è¨‚å–®`, 'order-cancelled');
      }
    });

    socket.on('orders_cleared', (data) => {
      // æ¸…ç©ºè¨‚å–®é¢æ¿
      updateOrdersPanel(null);
      showNotification('ç®¡ç†å“¡å·²æ¸…é™¤æ‰€æœ‰è¨‚å–®');
      sendBrowserNotification('è¨‚å–®æ¸…é™¤', 'ç®¡ç†å“¡å·²æ¸…é™¤æ‰€æœ‰è¨‚å–®', 'orders-cleared');
    });

    socket.on('store_changed', (data) => {
      const storeName = data.store_name || 'æ–°åº—å®¶';
      // é‡æ–°è¼‰å…¥ä»Šæ—¥è³‡è¨Šï¼ˆåŒ…æ‹¬æ–°èœå–®ï¼‰
      loadTodayInfo();
      showNotification(`ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`);
      sendBrowserNotification('åº—å®¶æ›´æ–°', `ä»Šæ—¥åº—å®¶å·²æ›´æ–°ï¼š${storeName}`, 'store-changed');
    });

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    // æŒ‰ Enter é–‹å§‹
    document.getElementById('username-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') startChat();
    });

    // === åœ˜éšŠèŠå¤©å®¤ ===
    let teamChatOpen = false;
    let unreadCount = 0;

    // åˆ‡æ›èŠå¤©å®¤å±•é–‹/æ”¶èµ·
    function toggleTeamChat() {
      const chatEl = document.getElementById('team-chat');
      teamChatOpen = !teamChatOpen;

      if (teamChatOpen) {
        chatEl.classList.remove('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–¼';
        // æ¸…é™¤æœªè®€æ•¸
        unreadCount = 0;
        updateUnreadBadge();
        // æ²å‹•åˆ°æœ€æ–°è¨Šæ¯
        const messagesEl = document.getElementById('team-chat-messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        chatEl.classList.add('minimized');
        document.getElementById('chat-toggle-btn').textContent = 'â–²';
      }
    }

    // æ›´æ–°æœªè®€å¾½ç« 
    function updateUnreadBadge() {
      const badge = document.getElementById('unread-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // è™•ç† Enter éµç™¼é€åœ˜éšŠè¨Šæ¯
    function handleTeamChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendTeamChatMessage();
      }
    }

    // ç™¼é€åœ˜éšŠèŠå¤©è¨Šæ¯
    async function sendTeamChatMessage() {
      const input = document.getElementById('team-chat-input');
      const content = input.value.trim();

      if (!content || !username) return;

      input.value = '';

      try {
        await fetch('/api/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, content })
        });
      } catch (err) {
        console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', err);
      }
    }

    // æ·»åŠ åœ˜éšŠèŠå¤©è¨Šæ¯åˆ°ç•«é¢
    function addTeamChatMessage(msg) {
      const messagesEl = document.getElementById('team-chat-messages');
      const isOwn = msg.username === username;

      const msgEl = document.createElement('div');
      msgEl.className = `team-chat-message ${isOwn ? 'own' : ''}`;

      const time = new Date(msg.timestamp).toLocaleTimeString('zh-TW', {
        hour: '2-digit',
        minute: '2-digit'
      });

      msgEl.innerHTML = `
        <div class="team-chat-message-header">
          <span class="team-chat-message-user">${msg.username}</span>
          <span class="team-chat-message-time">${time}</span>
        </div>
        <div class="team-chat-message-content">${msg.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
      `;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // è¼‰å…¥æ­·å²èŠå¤©è¨Šæ¯
    async function loadChatHistory() {
      try {
        const res = await fetch('/api/chat/messages');
        const data = await res.json();

        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => addTeamChatMessage(msg));
        }
      } catch (err) {
        console.error('è¼‰å…¥èŠå¤©è¨˜éŒ„å¤±æ•—:', err);
      }
    }

    // ç›£è½åœ˜éšŠèŠå¤©è¨Šæ¯
    socket.on('chat_message', (msg) => {
      addTeamChatMessage(msg);

      // å¦‚æœä¸æ˜¯è‡ªå·±çš„è¨Šæ¯
      if (msg.username !== username) {
        // èŠå¤©å®¤æ”¶èµ·æ™‚å¢åŠ æœªè®€æ•¸
        if (!teamChatOpen) {
          unreadCount++;
          updateUnreadBadge();
        }
        // ç™¼é€ç€è¦½å™¨é€šçŸ¥
        sendBrowserNotification(msg.username, msg.content, `chat-${msg.id}`);
      }
    });

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥èŠå¤©è¨˜éŒ„
    loadChatHistory();
  </script>
</body>
</html>
